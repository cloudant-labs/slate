<html lang="en">
<head>
  <title>IBM&reg; Cloudant&reg; NoSQL DB for Bluemix&reg;</title>
  <meta charset="utf-8"></meta>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"></meta>
  <meta name="viewport" content="width=device-width, initial-scale=1"></meta>
</head>

<body>
  <!-- Acrolinx: 2017-02-23 -->

  <h1 id="authorization">Authorization</h1>
  <p class="shortdesc">After you <a href="authentication.html">authenticate</a>, the next test is to decide whether you can do certain tasks. This process is called authorization.</p>
  <h2 id="roles">Roles</h2>
  <table>
    <thead>
      <tr>
        <th>Role</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><code>_reader</code></td>
        <td>Gives the user permission to read documents from the database.</td>
      </tr>
      <tr>
        <td><code>_writer</code></td>
        <td>Gives the user permission to create, update, and delete documents (except design documents) in the database.</td>
      </tr>
      <tr>
        <td><code>_admin</code></td>
        <td>Gives the user the ability to change security settings, including adding roles.</td>
      </tr>
      <tr>
        <td><code>_replicator</code></td>
        <td>Gives the user permission to replicate a database, including creating checkpoints.</td>
      </tr>
      <tr>
        <td><code>_db_updates</code></td>
        <td>Gives the user permission to use the global changes feed.</td>
      </tr>
      <tr>
        <td><code>_design</code></td>
        <td>Gives the user permission to read design documents.</td>
      </tr>
      <tr>
        <td><code>_shards</code></td>
        <td>Gives the user access to the <code>/$DATABASE/_shards</code> endpoint.</td>
      </tr>
      <tr>
        <td><code>_security</code></td>
        <td>Gives the user permission to read from the <code>/_api/v2/db/$DATABASE/_security</code> endpoint</td>
      </tr>
    </tbody>
  </table>
  <p>The credentials that you use to log in to the dashboard automatically have <code>_admin</code> permissions to all databases you create. Everyone and everything else, including users you share databases with and API keys you create, must be given a permission
    level explicitly.</p>
  <h2 id="viewing-permissions">Viewing Permissions</h2>
  <p>To see who has permissions to read, write, and manage the database, send a <code>GET</code> request to <code>https://$USERNAME.cloudant.com/_api/v2/db/$DATABASE/_security</code>.</p>
  <p><em>Example of using an HTTP request to determine permissions:</em></p>
  <pre class="codeblock"><code class="lang-http hljs"><span class="hljs-keyword">GET</span> <span class="hljs-string">/_api/v2/db/$DATABASE/_security</span> HTTP/1.1
</code></pre>
  <p><em>Example of using the command line to determine permissions:</em></p>
  <pre class="codeblock"><code class="lang-sh hljs">curl https://<span class="hljs-variable">$USERNAME</span>.cloudant.com/_api/v2/db/<span class="hljs-variable">$DATABASE</span>/_security
</code></pre>
  <!--

_Example of using JavaScript to determine permissions,:_

```javascript
var nano = require('nano');
var account = nano("https://"+$USERNAME+":"+$PASSWORD+"@"+$USERNAME+".cloudant.com");
account.request({
    db: $DATABASE,
    path: '_security'
    },
    function (err, body, headers) {
        if (!err) {
            console.log(body);
        }
    }
});
```

-->

  <p>The <code>cloudant</code> field in the response object contains an object with keys that are the user names that have permission to interact with the database. The <code>nobody</code> user name indicates what permissions are available to unauthenticated
    users, that is, any request made without authentication credentials.</p>
  <p>In the following example response, the <code>nobody</code> user name has <code>_reader</code> permissions. The effect is that the database is publicly readable.</p>
  <p><em>Example response to request for permissions:</em></p>
  <pre class="codeblock"><code class="lang-json hljs">{
    <span class="hljs-attr">"cloudant"</span>: {
        <span class="hljs-attr">"antsellseadespecteposene"</span>: [
            <span class="hljs-string">"_reader"</span>,
            <span class="hljs-string">"_writer"</span>,
            <span class="hljs-string">"_admin"</span>
        ],
        <span class="hljs-attr">"garbados"</span>: [
            <span class="hljs-string">"_reader"</span>,
            <span class="hljs-string">"_writer"</span>,
            <span class="hljs-string">"_admin"</span>
        ],
        <span class="hljs-attr">"nobody"</span>: [
            <span class="hljs-string">"_reader"</span>
        ]
    },
    <span class="hljs-attr">"_id"</span>: <span class="hljs-string">"_security"</span>
}
</code></pre>
  <h2 id="modifying-permissions">Modifying Permissions</h2>
  <p>To modify who has permissions to read, write, or manage a database, send a <code>PUT</code> request to <code>https://$USERNAME.cloudant.com/_api/v2/db/$DATABASE/_security</code>. To see what roles you can assign, see <a href="#roles">Roles</a>.</p>
  <p><em>Example of using HTTP to send an authorization modification request:</em></p>
  <pre class="codeblock"><code class="lang-http hljs"><span class="hljs-keyword">PUT</span> <span class="hljs-string">/_api/v2/db/$DATABASE/_security</span> HTTP/1.1
<span class="hljs-attribute">Content-Type</span>: application/json
</code></pre>
  <p><em>Example of using the command line to send an authorization modification request:</em></p>
  <pre class="codeblock"><code class="lang-sh hljs">curl https://<span class="hljs-variable">$USERNAME</span>:<span class="hljs-variable">$PASSWORD</span>@<span class="hljs-variable">$USERNAME</span>.cloudant.com/_api/v2/db/<span class="hljs-variable">$DATABASE</span>/_security \
    -X PUT \
    -H <span class="hljs-string">"Content-Type: application/json"</span> \
    <span class="hljs-_">-d</span> <span class="hljs-string">"<span class="hljs-variable">$JSON</span>"</span>
</code></pre>
  <!--

_Example of using JavaScript to send an authorization modification request:_

```javascript
var nano = require('nano');
var account = nano("https://"+$USERNAME+":"+$PASSWORD+"@"+$USERNAME+".cloudant.com");
account.request(
    {
        db: $DATABASE,
        path: '_security',
        method: 'PUT',
        body: '$JSON'
    },
    function (err, body, headers) {
        if (!err) {
            console.log(body);
        }
    }
);
```

-->

  <p>The request must provide a document in JSON format, describing a <code>cloudant</code> field. The field contains an object with keys that are the user names that have permission to interact with the database. The <code>nobody</code> user name indicates
    what permissions are available to unauthenticated users, that is, anybody.</p>
  <p>In the following example request, the <code>nobody</code> user name is given <code>_reader</code> permissions. This authorization makes the database publicly readable.</p>
  <p><em>Example of an authorization modification request document:</em></p>
  <pre class="codeblock"><code class="lang-json hljs">{
    <span class="hljs-attr">"cloudant"</span>: {
        <span class="hljs-attr">"antsellseadespecteposene"</span>: [
            <span class="hljs-string">"_reader"</span>,
            <span class="hljs-string">"_writer"</span>,
            <span class="hljs-string">"_admin"</span>
        ],
        <span class="hljs-attr">"garbados"</span>: [
            <span class="hljs-string">"_reader"</span>,
            <span class="hljs-string">"_writer"</span>,
            <span class="hljs-string">"_admin"</span>
        ],
        <span class="hljs-attr">"nobody"</span>: [
            <span class="hljs-string">"_reader"</span>
        ]
    }
}
</code></pre>
  <p>The response indicates whether the update was successful.</p>
  <p><em>Example response after a successful authorization modification request:</em></p>
  <pre class="codeblock"><code class="lang-json hljs">{
    <span class="hljs-attr">"ok"</span> : <span class="hljs-literal">true</span>
}
</code></pre>
  <p>You must run the <code>GET</code> command first to retrieve the security object. Then, you can modify that security object with new permissions. If you do not run the <code>GET</code> command and retrieve the security object before you run an API call,
    the result might disrupt your environment. For example, if you want to add a <code>nobody</code> user with read-only access, the following <em>incorrect</em> request removes <em>all</em> the other users with access to the database.</p>
  <p><em>Example of an incorrect authorization modification request document:</em></p>
  <pre class="codeblock"><code class="lang-json hljs">{
    <span class="hljs-attr">"cloudant"</span>: {
        <span class="hljs-attr">"nobody"</span>: [
            <span class="hljs-string">"_reader"</span>
        ]
    }
}
</code></pre>
  <h2 id="creating-api-keys">Creating API Keys</h2>
  <blockquote>
    <p> <strong>Note</strong>: An earlier method of generating API keys by <code>POST</code>ing to the <code>https://cloudant.com/api/generate_api_key</code> endpoint is deprecated.</p>
  </blockquote>
  <p>Use API keys to give access to a person or application without creating a new Cloudant account for that person or application. An API key consists of a randomly generated user name and password. The key is given the wanted access permissions.</p>
  <p>When generated, the API key can be used in the same way as a normal user account, for example by granting read, write, or admin access permissions.</p>
  <p>API keys are not the same as normal user accounts. In particular, an API key does not have access to the dashboard.</p>
  <p>An API key is primarily used to enable applications to access a database, with a determined level of access control.</p>
  <blockquote>
    <p> <strong>Note</strong>: If you choose to generate an API key through the dashboard, remember to record the key name and password. These values are both randomly generated, and cannot be retrieved if lost or forgotten.</p>
    <p> <strong>Note</strong>: <a href="https://www.ibm.com/support/knowledgecenter/SSTPQH_1.0.0/com.ibm.cloudant.local.doc/SSTPQH_1.0.0_welcome.html" target="_blank">IBM Cloudant Data Layer Local Edition (&quot;Cloudant Local&quot;) <img src="../images/launch-glyph.svg" alt="External link icon" title="External link icon"></a>      does not support API Keys. For a similar capability, create &quot;CouchDB&quot; style users, as described in the <a href="http://www-01.ibm.com/support/knowledgecenter/SSTPQH_1.0.0/com.ibm.cloudant.local.install.doc/topics/clinstall_db_security.html"
        target="_blank">IBM Knowledge Center <img src="../images/launch-glyph.svg" alt="External link icon" title="External link icon"></a>.</p>
  </blockquote>
  <p><em>Example of using an HTTP request to create an API key:</em></p>
  <pre class="codeblock"><code class="lang-http hljs"><span class="hljs-keyword">POST</span> <span class="hljs-string">https://&lt;username&gt;.cloudant.com/_api/v2/api_keys</span> HTTP/1.1
</code></pre>
  <p><em>Example of using the command line to create an API key:</em></p>
  <pre class="codeblock"><code class="lang-sh hljs">curl -X POST https://<span class="hljs-variable">$USERNAME</span>:<span class="hljs-variable">$PASSWORD</span>@<span class="hljs-variable">$USERNAME</span>.cloudant.com/_api/v2/api_keys
</code></pre>
  <!--

_Example of using JavaScript to create an API key:_

```javascript
var nano = require('nano');
var account = nano("https://$USERNAME:$PASSWORD@cloudant.com");
account.request(
    {
        db: '_api',
        path: 'v2/api_keys',
        method: 'POST'
    },
    function (err, body) {
        if (!err) {
            console.log(body);
        }
    }
);
```

-->

  <p>The response contains the generated key and password.</p>
  <p><em>Example response to request for an API key:</em></p>
  <pre class="codeblock"><code class="lang-json hljs">{
    <span class="hljs-attr">"password"</span>: <span class="hljs-string">"YPNCaIX1sJRX5upaL3eqvTfi"</span>,
    <span class="hljs-attr">"ok"</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">"key"</span>: <span class="hljs-string">"blentfortedsionstrindigl"</span>
}
</code></pre>
  <h2 id="using-api-keys">Using API keys</h2>
  <p>API keys are typically generated by using an account that has at least one database.</p>
  <p>However, when generated, it is possible to use the API key with other databases, or even with other accounts.</p>
  <p>By default, an API key has no permissions for anything. It must be given permissions explicitly.</p>
  <p>After you generate the API key, grant the key access-specific permissions for a specific database by sending a <code>PUT</code> request to
    <code>https://&lt;username&gt;.cloudant.com/_api/v2/db/&lt;database&gt;/_security</code>, as described in <a href="#modifying-permissions">modifying permissions</a>.</p>
  <p>The database does not have to be in the same account as the account used for generating the API key initially.</p>
  <p>To give an existing API key permissions to access a database in another account, do the following steps:</p>
  <ol>
    <li>Retrieve the existing security permissions for the database, as described <a href="#viewing-permissions">here</a>.</li>
    <li><a href="#modifying-permissions">Add</a> the details of the API key to the database security permissions, along with the <a href="#roles">roles</a> required.</li>
  </ol>
  <p>For an example of this process, see the blog article:
    <a href="https://dx13.co.uk/articles/2016/4/11/using-a-cloudant-api-key-with-multiple-cloudant-databases-and-accounts.html" target="_blank">Using a Cloudant API Key with Multiple Cloudant Databases and Accounts <img src="../images/launch-glyph.svg" alt="External link icon" title="External link icon"></a>.</p>
  <h2 id="deleting-api-keys">Deleting API keys</h2>
  <h3 id="to-remove-an-api-key-by-using-the-dashboard">To remove an API key by using the Dashboard</h3>
  <ol>
    <li>Click <code>Databases</code> -&gt; <code>Permissions</code>.</li>
    <li>Hover over the API key you would like to delete.</li>
    <li>Click the &#39;<code>X</code>&#39; that appears when you hover over the API key.</li>
  </ol>
  <h3 id="to-remove-an-api-key-by-using-the-cloudant-api">To remove an API key by using the Cloudant API</h3>
  <p>Use the <a href="#modifying-permissions">modifying permissions</a> technique to remove the API key from the list of users with access permission.</p>
  <p>This technique works because an API key is similar to a user, and is granted access permissions. By removing the API key from the list of users that have access permissions, the effect is to delete the API key.</p>
  <p>To remove the API key, send an HTTP <code>PUT</code> request to the same <code>_security</code> API endpoint you used to <a href="#creating-api-keys">create the API key</a>. Provide an updated list of the user names that have access permission. The
    updated list <em>must omit</em> the API key.</p>
  <h2 id="enabling-the-_users-database-with-cloudant">Enabling the <code>_users</code> database with Cloudant</h2>
  <p>You can use the
    <a href="http://docs.couchdb.org/en/1.6.1/intro/security.html#authentication-database" target="_blank">_users database <img src="../images/launch-glyph.svg" alt="External link icon" title="External link icon"></a> to manage roles in Cloudant. However,
    you must turn off Cloudant security for those roles first, by sending a JSON document to the <code>_security</code> endpoint of the database. For example, <code>https://&lt;username&gt;.cloudant.com/&lt;database&gt;/_security</code>.</p>
  <p><em>Example of using HTTP to submit a modification request:</em></p>
  <pre class="codeblock"><code class="lang-http hljs"><span class="hljs-keyword">PUT</span> <span class="hljs-string">/$DATABASE/_security</span> HTTP/1.1
<span class="hljs-attribute">Content-Type</span>: application/json
</code></pre>
  <p><em>Example of using the command line to submit a modification request:</em></p>
  <pre class="codeblock"><code class="lang-sh hljs">curl https://<span class="hljs-variable">$USERNAME</span>:<span class="hljs-variable">$PASSWORD</span>@<span class="hljs-variable">$USERNAME</span>.cloudant.com/<span class="hljs-variable">$DATABASE</span>/_security \
    -X PUT \
    -H <span class="hljs-string">"Content-Type: application/json"</span> \
    <span class="hljs-_">-d</span> @request-body.json
</code></pre>
  <p><em>Example modification request, in JSON format:</em></p>
  <pre class="codeblock"><code class="lang-json hljs">{
    <span class="hljs-attr">"couchdb_auth_only"</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">"members"</span>: {
        <span class="hljs-attr">"names"</span>: [<span class="hljs-string">"member"</span>],<span class="hljs-attr">"roles"</span>:[]
    },
    <span class="hljs-attr">"admins"</span>: {
        <span class="hljs-attr">"names"</span>: [<span class="hljs-string">"admin"</span>],<span class="hljs-attr">"roles"</span>:[]
    }
}
</code></pre>
  <p><em>Example response:</em></p>
  <pre class="codeblock"><code class="lang-json hljs">{
    <span class="hljs-attr">"ok"</span> : <span class="hljs-literal">true</span>
}
</code></pre>
  <footer>
    <div>
      <p>Copyright &copy; 2015, 2017. All Rights Reserved.</p>
    </div>
  </footer>
</body>
</html>