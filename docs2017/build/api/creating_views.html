<html lang="en">
<head>
  <title>IBM&reg; Cloudant&reg; NoSQL DB for Bluemix&reg;</title>
  <meta charset="utf-8"></meta>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"></meta>
  <meta name="viewport" content="width=device-width, initial-scale=1"></meta>
</head>

<body>
  <div id="working-with-views"></div>
  <div id="creating-views"></div>
  <h1 id="views-mapreduce-">Views (MapReduce)</h1>
  <p class="shortdesc">Views are used to obtain data stored within a database. Views are written using Javascript functions.</p>
  <h2 id="view-concepts">View concepts</h2>
  <p>Views are mechanisms for working with document content in databases. A view can selectively filter documents. It can speed up searching for content. It can be used to &#39;pre-process&#39; the results before they are returned to the client.</p>
  <p>Views are simply Javascript functions, defined within the <code>view</code> field of a design document. When you use a view, or more accurately when you perform a query using your view, the system applies the Javascript function to each and every document
    in the database. Views can be complex. You might choose to define a collection of Javascript functions to create the overall view required.</p>
  <h2 id="a-simple-view">A simple view</h2>
  <p>The simplest form of view is a map function. The map function produces output data that represents an analysis (a mapping) of the documents stored within the database.</p>
  <p>For example, you might want to find out which employees have had some safety training, and the date when that training was completed. You could do this by inspecting each document, looking for a field in the document called &quot;training&quot;. If
    the field is present, the employee completed the training on the date recorded as the value. If the field is not present, the employee has not completed the training.</p>
  <p>Using the <code>emit</code> function in a view function makes it easy to produce a list in response to running a query using the view. The list consists of key and value pairs, where the key helps you identify the specific document and the value provides
    just the precise detail you want. The list also includes metadata such as the number of key:value pairs returned.</p>
  <blockquote>
    <p> <strong>Note</strong>: The document <code>_id</code> is automatically included in each of the key:value pair result records. This is to make it easier for the client to work with the results.</p>
  </blockquote>
  <p><em>Example of a simple view, using a map function:</em></p>
  <pre class="codeblock"><code class="lang-javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">employee</span>) </span>{
    <span class="hljs-keyword">if</span>(employee.training) {
        emit(employee.number, employee.training);
    }
}
</code></pre>
  <p><em>Sample data for demonstrating the simple view example:</em></p>
  <pre class="codeblock"><code class="lang-json hljs">[
    {
        <span class="hljs-attr">"_id"</span>:<span class="hljs-string">"23598567"</span>,
        <span class="hljs-attr">"number"</span>:<span class="hljs-string">"23598567"</span>,
        <span class="hljs-attr">"training"</span>:<span class="hljs-string">"2014/05/21 10:00:00"</span>
    },
    {
        <span class="hljs-attr">"_id"</span>:<span class="hljs-string">"10278947"</span>,
        <span class="hljs-attr">"number"</span>:<span class="hljs-string">"10278947"</span>
    },
    {
        <span class="hljs-attr">"_id"</span>:<span class="hljs-string">"23598567"</span>,
        <span class="hljs-attr">"number"</span>:<span class="hljs-string">"23598567"</span>,
        <span class="hljs-attr">"training"</span>:<span class="hljs-string">"2014/07/30 12:00:00"</span>
    }
]
</code></pre>
  <p><em>Example response from running the simple view query:</em></p>
  <pre class="codeblock"><code class="lang-json hljs">{
    <span class="hljs-attr">"total_rows"</span>: <span class="hljs-number">2</span>,
    <span class="hljs-attr">"offset"</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">"rows"</span>: [
        {
            <span class="hljs-attr">"id"</span>:<span class="hljs-string">"23598567"</span>,
            <span class="hljs-attr">"number"</span>:<span class="hljs-string">"23598567"</span>,
            <span class="hljs-attr">"training"</span>:<span class="hljs-string">"2014/05/21 10:00:00"</span>
        },
        {
            <span class="hljs-attr">"id"</span>:<span class="hljs-string">"23598567"</span>,
            <span class="hljs-attr">"number"</span>:<span class="hljs-string">"23598567"</span>,
            <span class="hljs-attr">"training"</span>:<span class="hljs-string">"2014/07/30 12:00:00"</span>
        }
    ]
}
</code></pre>
  <h2 id="map-function-examples">Map function examples</h2>
  <h3 id="indexing-a-field">Indexing a field</h3>
  <p>The following map function checks whether the object has a <code>foo</code> field, and if so emits the value of this field. This check allows you to query against the value of the <code>foo</code> field.</p>
  <p><em>Example of indexing a field:</em></p>
  <pre class="codeblock"><code class="lang-javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">doc</span>) </span>{
    <span class="hljs-keyword">if</span> (doc.foo) {
        emit(doc._id, doc.foo);
    }
}
</code></pre>
  <h3 id="an-index-for-a-one-to-many-relationship">An index for a one to many relationship</h3>
  <p>If the object passed to <code>emit</code> has an <code>_id</code> field, a view query with <code>include_docs</code> set to <code>true</code> contains the document with the given ID.</p>
  <p><em>Example of indexing a one to many relationship:</em></p>
  <pre class="codeblock"><code class="lang-javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">doc</span>) </span>{
    <span class="hljs-keyword">if</span> (doc.friends) {
        <span class="hljs-keyword">for</span> (friend <span class="hljs-keyword">in</span> friends) {
            emit(doc._id, { <span class="hljs-string">"_id"</span>: friend });
        }
    }
}
</code></pre>
  <h3 id="complex-keys">Complex Keys</h3>
  <p>Keys are not limited to simple values. You can use arbitrary JSON values to influence sorting.</p>
  <p>When the key is an array, view results can be grouped by a sub-section of the key. For example, if keys have the form <code>[year, month, day]</code>, then results can be reduced to a single value or by year, month, or day. See <a href="using_views.html">Using Views</a>    for more information.</p>
  <h2 id="reduce-functions">Reduce functions</h2>
  <p>If a view has a reduce function, it is used to produce aggregate results for that view. A reduce function is passed a set of intermediate values and combines them to a single value. A reduce function must accept, as input, results emitted by its corresponding
    map function, as well as results returned by the reduce function itself. The latter case is referred to as a &#39;rereduce&#39;.</p>
  <p>Reduce functions are passed three arguments in the following order:</p>
  <ul>
    <li>keys - an array of values.</li>
    <li>values - an array of values.</li>
    <li>rereduce - a boolean flag.</li>
  </ul>
  <p><em>Example of a reduce function:</em></p>
  <pre class="codeblock"><code class="lang-javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">keys, values, rereduce</span>) </span>{
    <span class="hljs-keyword">return</span> sum(values);
}
</code></pre>
  <p>Reduce functions must handle two cases:</p>
  <ol>
    <li>
      <p>When <code>rereduce</code> is false:</p>
      <ul>
        <li><code>keys</code> is an array whose elements are arrays of the form <code>[key, id]</code>, where <code>key</code> is a key emitted by the map function, and <code>id</code> identifies the document from which the key was generated.</li>
        <li><code>values</code> is an array of the values emitted for the respective elements in <code>keys</code>, for example:
          <code>reduce([ [key1,id1], [key2,id2], [key3,id3] ], [value1,value2,value3], false)</code></li>
      </ul>
    </li>
    <li>
      <p>When <code>rereduce</code> is true:</p>
      <ul>
        <li><code>keys</code> is <code>null</code>.</li>
        <li><code>values</code> is an array of values returned by previous calls to the reduce function, for example: <code>reduce(null, [intermediate1,intermediate2,intermediate3], true)</code>.</li>
      </ul>
    </li>
  </ol>
  <p>Reduce functions should return a single value, suitable for both the <code>value</code> field of the final view, and as a member of the <code>values</code> array passed to the reduce function.</p>
  <p>Often, reduce functions can be written to handle rereduce calls without any extra code, like the summation function in the earlier example. In such cases, the <code>rereduce</code> argument can be ignored.</p>
  <h3 id="built-in-reduce-functions">Built-in reduce functions</h3>
  <p>For performance reasons, a few simple reduce functions are built in. Whenever possible, you should use one of these functions instead of writing your own.</p>
  <p>To use one of the built-in functions, put its name into the <code>reduce</code> field of the view object in your design document.</p>
  <table>
    <thead>
      <tr>
        <th>Function</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><code>_count</code></td>
        <td>Produces the row count for a given key. The values can be any valid JSON.</td>
      </tr>
      <tr>
        <td><code>_stats</code></td>
        <td>Produces a JSON structure containing the sum, the count, the min, the max, and the sum squared values. All values must be numeric.</td>
      </tr>
      <tr>
        <td><code>_sum</code></td>
        <td>Produces the sum of all values for a key. The values must be numeric.</td>
      </tr>
    </tbody>
  </table>
  <p>By feeding the results of <code>reduce</code> functions back into the <code>reduce</code> function, MapReduce is able to split up the analysis of huge data sets into discrete, parallel tasks, which can be completed much faster.</p>
  <h2 id="storing-the-view-definition">Storing the view definition</h2>
  <p>Each view is a Javascript function. Views are stored in design documents. So, to store a view, we simply store the function definition within a design document. A design document can be <a href="document.html#update">created or updated</a> just like
    any other document.</p>
  <p>To store a view definitions,
    <code>PUT</code> the view definition content into a <code>_design</code> document.</p>
  <p>In the following example, the <code>hadtraining</code> view is defined as a map function, and is available within the <code>views</code> field of the design document.</p>
  <p><em>Example of <code>PUT</code>ting a view into a design document called <code>training</code>,
using HTTP:</em></p>
  <pre class="codeblock"><code class="lang-http hljs"><span class="hljs-keyword">PUT</span> <span class="hljs-string">/$DATABASE/_design/training</span> HTTP/1.1
<span class="hljs-attribute">Content-Type</span>: application/json
</code></pre>
  <p><em>Example of <code>PUT</code>ting a view into a design document called <code>training</code>,
using the command line:</em></p>
  <pre class="codeblock"><code class="lang-sh hljs">curl -X PUT https://<span class="hljs-variable">$USERNAME</span>:<span class="hljs-variable">$PASSWORD</span>@<span class="hljs-variable">$USERNAME</span>.cloudant.com/<span class="hljs-variable">$DATABASE</span>/_design/training --data-binary @view.def
    <span class="hljs-comment"># where the design document is stored in the file `view.def`</span>
</code></pre>
  <p><em>Example view definition:</em></p>
  <pre class="codeblock"><code class="lang-json hljs">{
    <span class="hljs-attr">"views"</span> : {
        <span class="hljs-attr">"hadtraining"</span> : {
            <span class="hljs-attr">"map"</span> : <span class="hljs-string">"function(employee) { if(employee.training) { emit(employee.number, employee.training); } }"</span>
        }
    }
}
</code></pre>
  <footer>
    <div>
      <p>Copyright &copy; 2015, 2017. All Rights Reserved.</p>
    </div>
  </footer>
</body>
</html>