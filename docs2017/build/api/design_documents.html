<html lang="en">
<head>
  <title>IBM&reg; Cloudant&reg; NoSQL DB for Bluemix&reg;</title>
  <meta charset="utf-8"></meta>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"></meta>
  <meta name="viewport" content="width=device-width, initial-scale=1"></meta>
</head>

<body>
  <h1 id="design-documents">Design Documents</h1>
  <p class="shortdesc">Instead of storing data in a document, you might also have special documents that store other content, such as functions. The special documents are called &quot;design documents&quot;.</p>
  <p>Design documents are <a href="document.html">documents</a> that have an <code>_id</code> beginning with <code>_design/</code>. They can be read and updated in the same way as any other document in the database. Cloudant reads specific fields and values
    of design documents as functions. Design documents are used to <a href="#indexes">build indexes</a>, <a href="#update-validators">validate updates</a>, and <a href="#list-functions">format query results</a>.</p>
  <h2 id="creating-or-updating-a-design-document">Creating or updating a design document</h2>
  <ul>
    <li><strong>Method</strong>: <code>PUT /$DATABASE/_design/design-doc</code></li>
    <li><strong>Request</strong>: JSON of the design document information</li>
    <li><strong>Response</strong>: JSON status</li>
    <li><strong>Roles permitted</strong>: <code>_admin</code></li>
  </ul>
  <p>To create a design document, upload it to the specified database.</p>
  <p>In these examples,
    <code>$VARIABLES</code> might refer to standard or design documents. To distinguish between them, standard documents have an <code>_id</code> indicated by <code>$DOCUMENT_ID</code>, while design documents have an <code>_id</code> indicated by <code>$DESIGN_ID</code>.</p>
  <blockquote>
    <p> <strong>Note</strong>: If a design document is updated, Cloudant deletes the indexes from the previous version, and recreates the index from scratch. If you need to make changes to a design document for a larger database, have a look at the <a href="../guides/design_document_management.html#managing-changes-to-a-design-document">Design Document Management Guide</a>.</p>
  </blockquote>
  <p>The structure of design document is as follows:</p>
  <ul>
    <li><strong><code>_id</code></strong>: Design Document ID</li>
    <li><strong><code>_rev</code></strong>: Design Document Revision</li>
    <li><strong>views (optional)</strong>: An object describing MapReduce views.
      <ul>
        <li><strong>viewname</strong> (one for each view): View Definition.
          <ul>
            <li><strong>map</strong>: Map Function for the view.</li>
            <li><strong>reduce (optional)</strong>: Reduce Function for the view.</li>
            <li><strong>dbcopy (optional)</strong>: Database name for storing view results.</li>
          </ul>
        </li>
      </ul>
    </li>
    <li><strong>indexes (optional)</strong>: An object describing search indexes.
      <ul>
        <li><strong>index name</strong> (one for each index): Index definition.
          <ul>
            <li><strong>analyzer</strong>: Object describing the analyzer to be used or an object with the following fields:
              <ul>
                <li><strong>name</strong>: Name of the analyzer. Valid values are <code>standard</code>, <code>email</code>, <code>keyword</code>, <code>simple</code>, <code>whitespace</code>, <code>classic</code>, and <code>perfield</code>.</li>
                <li><strong>stopwords (optional)</strong>: An array of stop words. Stop words are words that should not be indexed. If this array is specified, it overrides the default list of stop words. The default list of stop words depends on the analyzer.
                  The list of stop words for the standard analyzer is:
                  <code>a</code>, <code>an</code>, <code>and</code>, <code>are</code>, <code>as</code>, <code>at</code>, <code>be</code>, <code>but</code>, <code>by</code>, <code>for</code>, <code>if</code>, <code>in</code>, <code>into</code>, <code>is</code>,
                  <code>it</code>, <code>no</code>, <code>not</code>, <code>of</code>, <code>on</code>, <code>or</code>, <code>such</code>, <code>that</code>, <code>the</code>, <code>their</code>, <code>then</code>, <code>there</code>, <code>these</code>,
                  <code>they</code>, <code>this</code>, <code>to</code>, <code>was</code>, <code>will</code>, and <code>with</code>.</li>
                <li><strong>default (for the per field analyzer)</strong>: default language to use if there is no language specified for the field.</li>
                <li><strong>fields (for the per field analyzer)</strong>: An object specifying which language to use to analyze each field of the index. Field names in the object correspond to field names in the index, that is, the first parameter of the
                  index function. The values of the fields are the languages to be used, for example <code>english</code>.</li>
              </ul>
            </li>
            <li><strong>index</strong>: Function that handles the indexing.</li>
          </ul>
        </li>
      </ul>
    </li>
    <li><strong>shows (optional)</strong>: Show functions.
      <ul>
        <li><strong>function name</strong> (one for each function): Function definition.</li>
      </ul>
    </li>
    <li><strong>lists (optional)</strong>: List functions.
      <ul>
        <li><strong>function name</strong> (one for each function): Function definition.</li>
      </ul>
    </li>
  </ul>
  <h2 id="copying-a-design-document">Copying a Design Document</h2>
  <p>You can copy the latest version of a design document to a new document by specifying the base document and target document. The copy is requested using the <code>COPY</code> HTTP request.</p>
  <blockquote>
    <p> <strong>Note</strong>:<code>COPY</code> is a non-standard HTTP command.</p>
    <p> <strong>Note</strong>: Copying a design document does not automatically reconstruct the view indexes. Like other views, these are recreated the first time the new view is accessed.</p>
  </blockquote>
  <p>The following example requests Cloudant to copy the design document <code>recipes</code> to the new design document <code>recipelist</code>, and produces a response containing the ID and revision of the new document.</p>
  <p><em>Example command to copy a design document, using HTTP:</em></p>
  <pre class="codeblock"><code class="lang-http hljs"><span class="hljs-keyword">COPY</span> <span class="hljs-string">/recipes/_design/recipes</span> HTTP/1.1
<span class="hljs-attribute">Content-Type</span>: application/json
<span class="hljs-attribute">Destination</span>: /recipes/_design/recipelist
</code></pre>
  <p><em>Example command to copy a design document, using the command line:</em></p>
  <pre class="codeblock"><code class="lang-sh hljs">curl <span class="hljs-string">"https://<span class="hljs-variable">$USERNAME</span>:<span class="hljs-variable">$PASSWORD</span>@<span class="hljs-variable">$ACCOUNT</span>.cloudant.com/recipes/_design/recipes"</span> \
    -X COPY \
    -H <span class="hljs-string">'Content-Type: application/json'</span> \
    -H <span class="hljs-string">'Destination: /recipes/_design/recipelist'</span>
</code></pre>
  <p><em>Example response to the copy request:</em></p>
  <pre class="codeblock"><code class="lang-json hljs">{
    <span class="hljs-attr">"id"</span>: <span class="hljs-string">"recipes/_design/recipelist"</span>,
    <span class="hljs-attr">"rev"</span>: <span class="hljs-string">"1-9c65296036141e575d32ba9c034dd3ee"</span>
}
</code></pre>
  <h3 id="the-structure-of-the-copy-command">The structure of the copy command</h3>
  <ul>
    <li><strong>Method</strong>: <code>COPY /$DATABASE/_design/design-doc</code></li>
    <li><strong>Request</strong>: None</li>
    <li><strong>Response</strong>: JSON describing the new document and revision.</li>
    <li><strong>Roles permitted</strong>: <code>_writer</code></li>
    <li><strong>Query Arguments</strong>:
      <ul>
        <li><strong>Argument</strong>: <code>rev</code>
          <ul>
            <li><strong>Description</strong>: Revision to copy from.</li>
            <li><strong>Optional</strong>: yes</li>
            <li><strong>Type</strong>: string</li>
          </ul>
        </li>
      </ul>
    </li>
    <li><strong>HTTP Headers</strong>
      <ul>
        <li><strong>Header</strong>: <code>Destination</code>
          <ul>
            <li><strong>Description</strong>: Destination document (and optional revision)</li>
            <li><strong>Optional</strong>: no</li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
  <p>The source design document is specified on the request line, with the <code>Destination</code> HTTP Header of the request specifying the target document.</p>
  <h3 id="copying-from-a-specific-revision">Copying from a specific revision</h3>
  <p>To copy from a specific version, add the <code>rev</code> argument to the query string.</p>
  <p>The new design document is created using the specified revision of the source document.</p>
  <p><em>Example command to copy a specific revision of the design document, using HTTP:</em></p>
  <pre class="codeblock"><code class="lang-http hljs"><span class="hljs-keyword">COPY</span> <span class="hljs-string">/recipes/_design/recipes?rev=1-e23b9e942c19e9fb10ff1fde2e50e0f5</span> HTTP/1.1
<span class="hljs-attribute">Content-Type</span>: application/json
<span class="hljs-attribute">Destination</span>: recipes/_design/recipelist
</code></pre>
  <p><em>Example command to copy a specific revision of the design document, using the command line:</em></p>
  <pre class="codeblock"><code class="lang-sh hljs">curl <span class="hljs-string">"https://<span class="hljs-variable">$USERNAME</span>:<span class="hljs-variable">$PASSWORD</span>@<span class="hljs-variable">$ACCOUNT</span>.cloudant.com/recipes/_design/recipes?rev=1-e23b9e942c19e9fb10ff1fde2e50e0f5"</span> \
    -X COPY \
    -H <span class="hljs-string">'Content-Type: application/json'</span> \
    -H <span class="hljs-string">'Destination: /recipes/_design/recipelist'</span>
</code></pre>
  <h3 id="copying-to-an-existing-design-document">Copying to an existing design document</h3>
  <p>To overwrite or copy to an existing document, specify the current revision string for the target document, using the <code>rev</code> parameter to the <code>Destination</code> HTTP Header string.</p>
  <p><em>Example command to overwrite an existing copy of the design document, using HTTP:</em></p>
  <pre class="codeblock"><code class="lang-http hljs">COPY /recipes/_design/recipes
Content-Type: application/json
Destination: recipes/_design/recipelist?rev=1-9c65296036141e575d32ba9c034dd3ee
</code></pre>
  <p><em>Example command to overwrite an existing copy of the design document, using the command line:</em></p>
  <pre class="codeblock"><code class="lang-sh hljs">curl <span class="hljs-string">"https://<span class="hljs-variable">$USERNAME</span>:<span class="hljs-variable">$PASSWORD</span>@<span class="hljs-variable">$ACCOUNT</span>.cloudant.com/recipes/_design/recipes"</span> \
    -X COPY \
    -H <span class="hljs-string">'Content-Type: application/json'</span> \
    -H <span class="hljs-string">'Destination: /recipes/_design/recipelist?rev=1-9c65296036141e575d32ba9c034dd3ee'</span>
</code></pre>
  <p>The return value is the ID and new revision of the copied document.</p>
  <p><em>Example response:</em></p>
  <pre class="codeblock"><code class="lang-json hljs">{
    <span class="hljs-attr">"id"</span> : <span class="hljs-string">"recipes/_design/recipes"</span>,
    <span class="hljs-attr">"rev"</span> : <span class="hljs-string">"2-55b6a1b251902a2c249b667dab1c6692"</span>
}
</code></pre>
  <h2 id="deleting-a-design-document">Deleting a design document</h2>
  <p>You can delete an existing design document. Deleting a design document also deletes all of the associated view indexes, and recovers the corresponding space on disk for the indexes in question.</p>
  <p>To delete a design document successfully, you must specify the current revision of the design document using the <code>rev</code> query argument.</p>
  <p><em>Example command to delete a design document, using HTTP:</em></p>
  <pre class="codeblock"><code class="lang-http hljs"><span class="hljs-keyword">DELETE</span> <span class="hljs-string">/recipes/_design/recipes?rev=2-ac58d589b37d01c00f45a4418c5a15a8</span> HTTP/1.1
</code></pre>
  <p><em>Example command to delete a design document, using using the command line:</em></p>
  <pre class="codeblock"><code class="lang-sh hljs">curl <span class="hljs-string">"https://<span class="hljs-variable">$USERNAME</span>:<span class="hljs-variable">$PASSWORD</span>@<span class="hljs-variable">$ACCOUNT</span>.cloudant.com/recipes/_design/recipes?rev=2-ac58d589b37d01c00f45a4418c5a15a8"</span> \
     -X DELETE
</code></pre>
  <p><em>Example response, containing the deleted document ID and revision:</em></p>
  <pre class="codeblock"><code class="lang-json hljs">{
    <span class="hljs-attr">"id"</span>: <span class="hljs-string">"recipe/_design/recipes"</span>,
    <span class="hljs-attr">"ok"</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">"rev"</span>: <span class="hljs-string">"3-7a05370bff53186cb5d403f861aca154"</span>
}
</code></pre>
  <h3 id="the-structure-of-the-delete-command">The structure of the delete command</h3>
  <ul>
    <li><strong>Method</strong>: <code>DELETE /db/_design/design-doc</code></li>
    <li><strong>Request</strong>: None</li>
    <li><strong>Response</strong>: JSON of deleted design document.</li>
    <li><strong>Roles permitted</strong>: <code>_writer</code></li>
    <li><strong>Query Arguments</strong>:
      <ul>
        <li><strong>Argument</strong>: <code>rev</code>
          <ul>
            <li><strong>Description</strong>: Current revision of the document for validation.</li>
            <li><strong>Optional</strong>: yes</li>
            <li><strong>Type</strong>: string</li>
          </ul>
        </li>
      </ul>
    </li>
    <li><strong>HTTP Headers</strong>
      <ul>
        <li><strong>Header</strong>: <code>If-Match</code>
          <ul>
            <li><strong>Description</strong>: Current revision of the document for validation.</li>
            <li><strong>Optional</strong>: yes</li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
  <h2 id="views">Views</h2>
  <p>An important use of design documents is for creating views. These are discussed in more detail <a href="creating_views.html">here</a>.</p>
  <h2 id="rewrite-rules">Rewrite rules</h2>
  <p>A design document can contain rules for URL rewriting, by using an array in the <code>rewrites</code> field. Requests that match the rewrite rules must have a URL path that starts with <code>/$DATABASE/_design/doc/_rewrite</code>.</p>
  <p>Each rule is a JSON object with 4 fields:</p>
  <table>
    <thead>
      <tr>
        <th>Field</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><code>from</code></td>
        <td>A path relative to <code>/$DATABASE/_design/doc/_rewrite</code>, used to match URLs to rewrite rules. Path elements that start with a <code>:</code> are treated as variables, and match any string that does not contain a <code>/</code>. A <code>*</code>          can only appear at the end of the string, and matches any string - including slashes.</td>
      </tr>
      <tr>
        <td><code>method</code></td>
        <td>The HTTP method that should be matched on.</td>
      </tr>
      <tr>
        <td><code>query</code></td>
        <td>The query part of the resulting URL. This is a JSON object containing the key/value pairs of the query.</td>
      </tr>
      <tr>
        <td><code>to</code></td>
        <td>The path (relative to <code>/$DATABASE/_design/doc/</code> and not including the query part of the URL) that is the result of the rewriting step. Variables captured in <code>from</code> can be used in <code>to</code>. <code>*</code> can also be
          used and contains everything captured by the pattern in <code>from</code>.</td>
      </tr>
    </tbody>
  </table>
  <p><em>Example JSON describing some rewrite rules:</em></p>
  <pre class="codeblock"><code class="lang-json hljs">{
    <span class="hljs-attr">"rewrites"</span>: [
        {
            <span class="hljs-attr">"from"</span>: <span class="hljs-string">"/"</span>,
            <span class="hljs-attr">"to"</span>: <span class="hljs-string">"index.html"</span>,
            <span class="hljs-attr">"method"</span>: <span class="hljs-string">"GET"</span>,
            <span class="hljs-attr">"query"</span>: {}
        },
        {
            <span class="hljs-attr">"from"</span>: <span class="hljs-string">"/foo/:var"</span>,
            <span class="hljs-attr">"to"</span>: <span class="hljs-string">"/foo"</span>,
            <span class="hljs-attr">"method"</span>: <span class="hljs-string">"GET"</span>,
            <span class="hljs-attr">"query"</span>: {<span class="hljs-attr">"v"</span>: <span class="hljs-string">"var"</span>}
        }
    ]
}
</code></pre>
  <h3 id="example-rewrite-rules">Example rewrite rules</h3>
  <p>The following table has some more examples of rewriting URL components:</p>
  <table>
    <thead>
      <tr>
        <th>Rule</th>
        <th>URL</th>
        <th>Rewrite to</th>
        <th>Tokens</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><code>{&quot;from&quot;: &quot;/a/b&quot;, &quot;to&quot;: &quot;/some/&quot;}</code></td>
        <td><code>/$DATABASE/_design/doc/_rewrite/a/b?k=v</code></td>
        <td><code>/$DATABASE/_design/doc/some?k=v</code></td>
        <td><code>k = v</code></td>
      </tr>
      <tr>
        <td><code>{&quot;from&quot;: &quot;/a/b&quot;, &quot;to&quot;: &quot;/some/:var&quot;}</code></td>
        <td><code>/$DATABASE/_design/doc/_rewrite/a/b</code></td>
        <td><code>/$DATABASE/_design/doc/some/b?var=b</code></td>
        <td><code>var = b</code></td>
      </tr>
      <tr>
        <td><code>{&quot;from&quot;: &quot;/a&quot;, &quot;to&quot;: &quot;/some/*&quot;}</code></td>
        <td><code>/$DATABASE/_design/doc/_rewrite/a</code></td>
        <td><code>/$DATABASE/_design/doc/some</code></td>
        <td></td>
      </tr>
      <tr>
        <td><code>{&quot;from&quot;: &quot;/a/*&quot;, &quot;to&quot;: &quot;/some/*}</code></td>
        <td><code>/$DATABASE/_design/doc/_rewrite/a/b/c</code></td>
        <td><code>/$DATABASE/_design/doc/some/b/c</code></td>
        <td></td>
      </tr>
      <tr>
        <td><code>{&quot;from&quot;: &quot;/a&quot;, &quot;to&quot;: &quot;/some/*&quot;}</code></td>
        <td><code>/$DATABASE/_design/doc/_rewrite/a</code></td>
        <td><code>/$DATABASE/_design/doc/some</code></td>
        <td></td>
      </tr>
      <tr>
        <td><code>{&quot;from&quot;: &quot;/a/:foo/*&quot;,&quot;to&quot;: &quot;/some/:foo/*&quot;}</code></td>
        <td><code>/$DATABASE/_design/doc/_rewrite/a/b/c</code></td>
        <td><code>/$DATABASE/_design/doc/some/b/c?foo=b</code></td>
        <td><code>foo = b</code></td>
      </tr>
      <tr>
        <td><code>{&quot;from&quot;: &quot;/a/:foo&quot;, &quot;to&quot;: &quot;/some&quot;, &quot;query&quot;: { &quot;k&quot;: &quot;:foo&quot; }}</code></td>
        <td><code>/$DATABASE/_design/doc/_rewrite/a/b</code></td>
        <td><code>/$DATABASE/_design/doc/some/?k=b&amp;foo=b</code></td>
        <td><code>foo =:= b</code></td>
      </tr>
      <tr>
        <td><code>{&quot;from&quot;: &quot;/a&quot;, &quot;to&quot;: &quot;/some/:foo&quot; }</code></td>
        <td><code>/$DATABASE/_design/doc/_rewrite/a?foo=b</code></td>
        <td><code>$DATABASE/_design/doc/some/b&amp;foo=b</code></td>
        <td><code>foo = b</code></td>
      </tr>
    </tbody>
  </table>
  <h2 id="indexes">Indexes</h2>
  <p>All queries operate on pre-defined indexes defined in design documents. These indexes are:</p>
  <ul>
    <li><a href="search.html">Search</a></li>
    <li><a href="creating_views.html">MapReduce</a></li>
  </ul>
  <p>For example, to create a design document used for searching, you must ensure that two conditions are true:</p>
  <ol>
    <li>You have identified the document as a design document by having an <code>_id</code> starting with <code>_design/</code>.</li>
    <li>A <a href="search.html">search index</a> has been created within the document by <a href="document.html#update">updating</a> the document with the appropriate field or by <a href="document.html#create">creating</a> a new document containing the search
      index.</li>
  </ol>
  <p>As soon as the search index design document exists and the index has been built, you can make queries using it.</p>
  <p>For more information about search indexing, refer to the <a href="search.html">search</a> section of this documentation.</p>
  <h3 id="general-notes-on-functions-in-design-documents">General notes on functions in design documents</h3>
  <p>Functions in design documents are run on multiple nodes for each document, and might be run several times. To avoid inconsistencies, they need to be <a href="https://en.wikipedia.org/wiki/Idempotence#Computer_science_meaning" target="_blank">idempotent <img src="../images/launch-glyph.svg" alt="External link icon" title="External link icon"></a>,
    meaning they need to behave identically when run multiple times or on different nodes. In particular, you should avoid using functions that generate random numbers or return the current time.</p>
  <h2 id="list-functions">List Functions</h2>
  <p>Use list functions to customize the format of
    <a href="creating_views.html#using-views">MapReduce</a> query results. A good example of their use is when you want to access Cloudant directly from a browser, and need data to be returned in a different format, such as HTML.</p>
  <p>You can add any query parameters to the request that would normally be used for a view request.</p>
  <p>Instead of using a MapReduce index, you can also use <code>_all_docs</code>.</p>
  <blockquote>
    <p> <strong>Note</strong>: The result of a list function is not stored. This means that the function is executed every time a request is made. As a consequence, using MapReduce functions might be more efficient. For web and mobile applications, consider
      whether any computations done in a list function would be better placed in the application tier.</p>
  </blockquote>
  <p>When you define a list function, you use it by sending a <code>GET</code> request to
    <code>https://$USERNAME.cloudant.com/$DATABASE/$DESIGN_ID/_list/$LIST_FUNCTION/$MAPREDUCE_INDEX</code>. In this request:</p>
  <ul>
    <li><code>$LIST_FUNCTION</code> is the name of list function you defined.</li>
    <li><code>$MAPREDUCE_INDEX</code> is the name of the index providing the query results you want to format.</li>
  </ul>
  <p>List functions require two arguments:
    <a href="#head"><code>head</code></a> and <a href="#req"><code>req</code></a>.</p>
  <p>The <code>head</code> argument identifies the documents to be processed by the list function.</p>
  <p>The <code>req</code> argument contains additional information about the request. It enables you to create list functions that are more dynamic, because they are based on additional factors such as query parameters or the user context.</p>
  <p>The values within the <code>req</code> argument are similar to the query parameters described
    <a href="cloudant_query.html#query-parameters">here</a>.</p>
  <p><em>Example design document referencing a list function, expressed using JSON:</em></p>
  <pre class="codeblock"><code class="lang-json hljs">{
    <span class="hljs-attr">"_id"</span>: <span class="hljs-string">"_design/list_example"</span>,
    <span class="hljs-attr">"lists"</span>: {
        <span class="hljs-attr">"FUNCTION_NAME"</span>: <span class="hljs-string">"function (head, req) { ... }"</span>
    }
}
</code></pre>
  <p><em>Example of a list function, in pseudo-code:</em></p>
  <pre class="codeblock"><code class="lang-javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">head, req</span>) </span>{
    <span class="hljs-comment">// specify our headers</span>
    start({
        <span class="hljs-attr">headers</span>: {
            <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">'text/html'</span>
        }
    });

    <span class="hljs-comment">// send the response, line by line</span>
    send(<span class="hljs-string">'&lt;html&gt;&lt;body&gt;&lt;table&gt;'</span>);
    send(<span class="hljs-string">'&lt;tr&gt;&lt;th&gt;ID&lt;/th&gt;&lt;th&gt;Key&lt;/th&gt;&lt;th&gt;Value&lt;/th&gt;&lt;/tr&gt;'</span>)
    <span class="hljs-keyword">while</span>(row = getRow()){
        send(<span class="hljs-string">''</span>.concat(
            <span class="hljs-string">'&lt;tr&gt;'</span>,
            <span class="hljs-string">'&lt;td&gt;'</span> + toJSON(row.id) + <span class="hljs-string">'&lt;/td&gt;'</span>,
            <span class="hljs-string">'&lt;td&gt;'</span> + toJSON(row.key) + <span class="hljs-string">'&lt;/td&gt;'</span>,
            <span class="hljs-string">'&lt;td&gt;'</span> + toJSON(row.value) + <span class="hljs-string">'&lt;/td&gt;'</span>,
            <span class="hljs-string">'&lt;/tr&gt;'</span>
        ));
    }
    send(<span class="hljs-string">'&lt;/table&gt;&lt;/body&gt;&lt;/html&gt;'</span>);
}
</code></pre>
  <p><em>Example invocation of a list function, using HTTP:</em></p>
  <pre class="codeblock"><code class="lang-http hljs"><span class="hljs-keyword">GET</span> <span class="hljs-string">/$DATABASE/$DESIGN_ID/_list/$LIST_FUNCTION/$MAPREDUCE_INDEX</span> HTTP/1.1
</code></pre>
  <p><em>Example invocation of a list function, using the command line:</em></p>
  <pre class="codeblock"><code class="lang-sh hljs">curl <span class="hljs-string">"https://<span class="hljs-variable">$ACCOUNT</span>.cloudant.com/<span class="hljs-variable">$DATABASE</span>/<span class="hljs-variable">$DESIGN_ID</span>/_list/<span class="hljs-variable">$LIST_FUNCTION</span>/<span class="hljs-variable">$MAPREDUCE_INDEX</span>"</span> \
    -u <span class="hljs-string">"<span class="hljs-variable">$USERNAME</span>:<span class="hljs-variable">$PASSWORD</span>"</span>
</code></pre>
  <!--

_Example invocation of a list function, using Javascript:_

```javascript
var nano = require('nano');
var account = nano("https://"+$USERNAME+":"+$PASSWORD+"@"+$USERNAME+".cloudant.com");
var db = account.use($DATABASE);

db.view_with_list($DESIGN_ID, $MAPREDUCE_INDEX, $LIST_FUNCTION, function (err, body, headers) {
    if (!err) {
        console.log(body);
    }
});
```

-->

  <h3 id="head">head</h3>
  <table>
    <thead>
      <tr>
        <th>Field</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><code>offset</code></td>
        <td>Offset where the document list started</td>
      </tr>
      <tr>
        <td><code>total_rows</code></td>
        <td>Number of documents in the view</td>
      </tr>
    </tbody>
  </table>
  <h3 id="req">req</h3>
  <table>
    <thead>
      <tr>
        <th>Field</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><code>body</code></td>
        <td>Request body data as string. If the request method is <code>GET</code>, this field contains the value <code>undefined</code>. If the method is <code>DELETE</code> or <code>HEAD</code>, the value is &quot;&quot; (the empty string).</td>
      </tr>
      <tr>
        <td><code>cookie</code></td>
        <td>Cookies object.</td>
      </tr>
      <tr>
        <td><code>form</code></td>
        <td>Form data object. Contains the decoded body as key-value pairs if the Content-Type header was <code>application/x-www-form-urlencoded</code>.</td>
      </tr>
      <tr>
        <td><code>headers</code></td>
        <td>Request headers object.</td>
      </tr>
      <tr>
        <td><code>id</code></td>
        <td>Requested document ID string if it was specified or null otherwise.</td>
      </tr>
      <tr>
        <td><code>info</code></td>
        <td>Database information</td>
      </tr>
      <tr>
        <td><code>method</code></td>
        <td>Request method as string or array. String value is one of the methods: <code>HEAD</code>, <code>GET</code>, <code>POST</code>, <code>PUT</code>, <code>DELETE</code>, <code>OPTIONS</code>, or <code>TRACE</code>. Alternatively, the method is represented
          as an array of character codes.</td>
      </tr>
      <tr>
        <td><code>path</code></td>
        <td>List of requested path sections.</td>
      </tr>
      <tr>
        <td><code>peer</code></td>
        <td>Request source IP address.</td>
      </tr>
      <tr>
        <td><code>query</code></td>
        <td>URL query parameters object. Multiple keys are not supported, therefore the last duplicate key overrides the others.</td>
      </tr>
      <tr>
        <td><code>requested_path</code></td>
        <td>List of actual requested path section.</td>
      </tr>
      <tr>
        <td><code>raw_path</code></td>
        <td>Raw requested path string.</td>
      </tr>
      <tr>
        <td><code>secObj</code></td>
        <td>The database&#39;s <a href="authorization.html#viewing-permissions">security object</a></td>
      </tr>
      <tr>
        <td><code>userCtx</code></td>
        <td>Context about the currently authenticated user, specifically their <code>name</code> and <code>roles</code> within the current database.</td>
      </tr>
      <tr>
        <td><code>uuid</code></td>
        <td>A generated UUID.</td>
      </tr>
    </tbody>
  </table>
  <h2 id="show-functions">Show Functions</h2>
  <p>Show functions are similar to <a href="#list-functions">list functions</a>, but are used to format individual documents. They are used when you want to access Cloudant directly from a browser, and need data to be returned in a different format, such
    as HTML.</p>
  <blockquote>
    <p> <strong>Note</strong>: The result of a show function is not stored. This means that the function is executed every time a request is made. As a consequence, using <a href="creating_views.html#a-simple-view">map functions</a> might be more efficient.
      For web and mobile applications, consider whether any computations done in a show function would be better placed in the application tier.</p>
  </blockquote>
  <p>Show functions require two arguments: <code>doc</code>, and <a href="#req">req</a>.</p>
  <p><code>doc</code> is the document requested by the show function.</p>
  <p>The <a href="#req"><code>req</code></a> argument contains additional information about the request. It enables you to create show functions that are more dynamic, because they are based on additional factors such as query parameters or the user context.</p>
  <p>The <a href="#req"><code>req</code></a> argument corresponds to that used in a <a href="#list-functions">list function</a>.</p>
  <p>When you have defined a show function, you query it by sending a <code>GET</code> request to <code>https://$USERNAME.cloudant.com/$DATABASE/$DESIGN_ID/_show/$SHOW_FUNCTION/$DOCUMENT_ID</code>, where <code>$SHOW_FUNCTION</code> is the name of the function
    that is included in the design document <code>$DESIGN_ID</code>.</p>
  <p><em>Example of a design document with a show function:</em></p>
  <pre class="codeblock"><code class="lang-json hljs">{
    <span class="hljs-attr">"_id"</span>: <span class="hljs-string">"_design/show_example"</span>,
    <span class="hljs-attr">"shows"</span>: {
        <span class="hljs-attr">"FUNCTION_NAME"</span>: <span class="hljs-string">"function (doc, req) { ... }"</span>
    }
}
</code></pre>
  <p><em>Example of a show function:</em></p>
  <pre class="codeblock"><code class="lang-javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">doc, req</span>) </span>{
    <span class="hljs-keyword">if</span> (doc) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello from "</span> + doc._id + <span class="hljs-string">"!"</span>;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello, world!"</span>;
    }
}
</code></pre>
  <p><em>Example of a show function query, using HTTP:</em></p>
  <pre class="codeblock"><code class="lang-http hljs"><span class="hljs-keyword">GET</span> <span class="hljs-string">/$DATABASE/$DESIGN_ID/_show/$SHOW_FUNCTION/$DOCUMENT_ID</span> HTTP/1.1
<span class="hljs-attribute">Host</span>: $USERNAME.cloudant.com
</code></pre>
  <p><em>Example of a show function query, using the command line:</em></p>
  <pre class="codeblock"><code class="lang-sh hljs">curl https://<span class="hljs-variable">$USERNAME</span>.cloudant.com/<span class="hljs-variable">$DATABASE</span>/<span class="hljs-variable">$DESIGN_ID</span>/_show/<span class="hljs-variable">$SHOW_FUNCTION</span>/<span class="hljs-variable">$DOCUMENT_ID</span> \
     -u <span class="hljs-variable">$USERNAME</span>
</code></pre>
  <!--

_Example of a show function query, using Javascript:_

```javascript
var nano = require('nano');
var account = nano("https://"+$USERNAME+":"+$PASSWORD+"@"+$USERNAME+".cloudant.com");
var db = account.use($DATABASE);

db.show($DESIGN_ID, $SHOW_FUNCTION, $DOCUMENT_ID, function (err, body) {
    if (!err) {
        console.log(body);
    }
});
```

-->

  <h2 id="update-handlers">Update Handlers</h2>
  <p>Update handlers are custom functions that create or update a document. They are used for tasks such as providing server-side modification timestamps, and performing document updates to individual fields without the latest revision.</p>
  <p>Update handlers require two arguments: <code>doc</code> and <a href="#req">req</a>.</p>
  <p>If a document ID is provided in the request to the update handler, then <code>doc</code> is the document corresponding to that ID. If no ID is provided,
    <code>doc</code> is <code>null</code>.</p>
  <p>The <a href="#req"><code>req</code></a> argument contains additional information about the request. It enables you to create update handlers that are more dynamic, because they are based on additional factors such as query parameters or the user context.</p>
  <p>The <a href="#req"><code>req</code></a> argument corresponds to that used in a <a href="#list-functions">list function</a>.</p>
  <p>Update handler functions must return an array of two elements. The first element is the document to save, or <code>null</code> if you do not want to save the document. The second element is the response body.</p>
  <p>There are two methods for querying update handlers:</p>
  <table>
    <thead>
      <tr>
        <th>Method</th>
        <th>URL</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><code>POST</code></td>
        <td><code>https://$USERNAME.cloudant.com/$DATABASE/$DESIGN_ID/_update/$UPDATE_HANDLER</code></td>
      </tr>
      <tr>
        <td><code>PUT</code></td>
        <td><code>https://$USERNAME.cloudant.com/$DATABASE/$DESIGN_ID/_update/$UPDATE_HANDLER/$DOCUMENT_ID</code></td>
      </tr>
    </tbody>
  </table>
  <p>In these methods:</p>
  <table>
    <thead>
      <tr>
        <th>Variable</th>
        <th>Purpose</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><code>$DESIGN_ID</code></td>
        <td>The ID of the document defining the update handler.</td>
      </tr>
      <tr>
        <td><code>$DOCUMENT_ID</code></td>
        <td>The ID of the document that the handler must work with.</td>
      </tr>
      <tr>
        <td><code>$UPDATE_HANDLER</code></td>
        <td>The name of the update handler.</td>
      </tr>
    </tbody>
  </table>
  <p><em>Example of a design document with an update handler:</em></p>
  <pre class="codeblock"><code class="lang-json hljs">{
    <span class="hljs-attr">"_id"</span>: <span class="hljs-string">"_design/update_example"</span>,
    <span class="hljs-attr">"updates"</span>: {
        <span class="hljs-attr">"UPDATE_HANDLER_NAME"</span>: <span class="hljs-string">"function (doc, req) { ... }"</span>
    }
}
</code></pre>
  <p><em>Example of an update handler:</em></p>
  <pre class="codeblock"><code class="lang-javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">doc, req</span>)</span>{
    <span class="hljs-keyword">if</span> (!doc){
        <span class="hljs-keyword">if</span> (<span class="hljs-string">'id'</span> <span class="hljs-keyword">in</span> req &amp;&amp; req.id){
            <span class="hljs-comment">// create new document</span>
            <span class="hljs-keyword">return</span> [{<span class="hljs-attr">_id</span>: req.id}, <span class="hljs-string">'New World'</span>]
        }
        <span class="hljs-comment">// change nothing in database</span>
        <span class="hljs-keyword">return</span> [<span class="hljs-literal">null</span>, <span class="hljs-string">'Empty World'</span>]
    }
    doc.world = <span class="hljs-string">'hello'</span>;
    doc.edited_by = req.userCtx.name
    <span class="hljs-keyword">return</span> [doc, <span class="hljs-string">'Edited World!'</span>]
}
</code></pre>
  <p><em>Example of an update handler query, using HTTP:</em></p>
  <pre class="codeblock"><code class="lang-http hljs"><span class="hljs-keyword">POST</span> <span class="hljs-string">/$DATABASE/$DESIGN_ID/_update/$UPDATE_HANDLER</span> HTTP/1.1
<span class="hljs-attribute">Content-Type</span>: application/json
</code></pre>
  <p><em>Example of an update handler query, using the command line:</em></p>
  <pre class="codeblock"><code class="lang-sh hljs">curl <span class="hljs-string">"https://<span class="hljs-variable">$ACCOUNT</span>.cloudant.com/<span class="hljs-variable">$DATABASE</span>/<span class="hljs-variable">$DESIGN_ID</span>/_update/<span class="hljs-variable">$UPDATE_HANDLER</span>"</span> \
    -X POST \
    -H <span class="hljs-string">'Content-Type: application/json'</span> \
    -u <span class="hljs-string">"<span class="hljs-variable">$USERNAME</span>:<span class="hljs-variable">$PASSWORD</span>"</span> \
    <span class="hljs-_">-d</span> <span class="hljs-string">"<span class="hljs-variable">$JSON</span>"</span>
</code></pre>
  <!--

_Example of an update handler query, using Javascript:_

```javascript
var nano = require('nano');
var account = nano("https://"+$USERNAME+":"+$PASSWORD+"@"+$USERNAME+".cloudant.com");
var db = account.use($DATABASE);

db.atomic($DESIGN_ID, $UPDATE_HANDLER, $DOCUMENT_ID, $JSON, function (err, body) {
    if (!err) {
        console.log(body);
    }
});
```

-->

  <h2 id="filter-functions">Filter Functions</h2>
  <p>Filter functions are design documents that enable you to filter the <a href="database.html#get-changes">changes feed</a>. They work by applying tests to each of the objects included in the changes feed.</p>
  <p>If any of the function tests fail, the object is &#39;removed&#39; or &#39;filtered&#39; from the feed. If the function returns a <code>true</code> result when applied to a change, the change remains in the feed. This means that filter functions let
    you &#39;remove&#39; or &#39;ignore&#39; changes that you do not want to monitor.</p>
  <blockquote>
    <p> <strong>Note</strong>: Filter functions can also be used to modify a <a href="advanced_replication.html#filtered-replication">replication task</a>.</p>
  </blockquote>
  <p>Filter functions require two arguments: <code>doc</code> and <a href="#req"><code>req</code></a>.</p>
  <p>The <code>doc</code> argument represents the document being tested for filtering.</p>
  <p>The <code>req</code> argument contains additional information about the request. It enables you to create filter functions that are more dynamic, because they are based on additional factors such as query parameters or the user context.</p>
  <p>For example, you could control aspects of the filter function tests by using dynamic values provided as part of the HTTP request. In many filter function use cases, however, only the <code>doc</code> parameter is used.</p>
  <p>The <a href="#req"><code>req</code></a> argument corresponds to that used in a <a href="#list-functions">list function</a>.</p>
  <p><em>Example design document containing a filter function:</em></p>
  <pre class="codeblock"><code class="lang-json hljs">{
    <span class="hljs-attr">"_id"</span>:<span class="hljs-string">"_design/FILTER_EXAMPLE"</span>,
    <span class="hljs-attr">"filters"</span>: {
        <span class="hljs-attr">"FILTER_EXAMPLE"</span>: <span class="hljs-string">"function (doc, req) { ... }"</span>
    }
}
</code></pre>
  <p><em>Example of a filter function:</em></p>
  <pre class="codeblock"><code class="lang-javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">doc, req</span>)</span>{
    <span class="hljs-comment">// we need only `mail` documents</span>
    <span class="hljs-keyword">if</span> (doc.type != <span class="hljs-string">'mail'</span>){
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    <span class="hljs-comment">// we're interested only in `new` ones</span>
    <span class="hljs-keyword">if</span> (doc.status != <span class="hljs-string">'new'</span>){
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// passed!</span>
}
</code></pre>
  <p>To apply a filter function to the changes feed, include the <code>filter</code> parameter in the <code>_changes</code> query, providing the name of the filter to use.</p>
  <p><em>Example of an filter function applied to a <code>_changes</code> query, using HTTP:</em></p>
  <pre class="codeblock"><code class="lang-http hljs"><span class="hljs-keyword">GET</span> <span class="hljs-string">/$DATABASE/_changes?filter=$DESIGN_ID/$FILTER_FUNCTION</span> HTTP/1.1
</code></pre>
  <p><em>Example of an filter function applied to a <code>_changes</code> query, using the command line:</em></p>
  <pre class="codeblock"><code class="lang-sh hljs">curl <span class="hljs-string">"https://<span class="hljs-variable">$ACCOUNT</span>.cloudant.com/<span class="hljs-variable">$DATABASE</span>/_changes?filter=<span class="hljs-variable">$DESIGN_ID</span>/<span class="hljs-variable">$FILTER_FUNCTION</span>"</span> \
     -u <span class="hljs-string">"<span class="hljs-variable">$USERNAME</span>:<span class="hljs-variable">$PASSWORD</span>"</span>
</code></pre>
  <p>The <code>req</code> argument gives you access to aspects of the HTTP request using the <code>query</code> property.</p>
  <p>_Example of supplying a <code>req</code> argument, using HTTP:</p>
  <pre class="codeblock"><code class="lang-http hljs"><span class="hljs-keyword">GET</span> <span class="hljs-string">/$DATABASE/_changes?filter=$DESIGN_ID/$FILTER_FUNCTION&amp;status=new</span> HTTP/1.1
</code></pre>
  <p>_Example of supplying a <code>req</code> argument, using the command line:</p>
  <pre class="codeblock"><code class="lang-sh hljs">curl <span class="hljs-string">"https://<span class="hljs-variable">$ACCOUNT</span>.cloudant.com/<span class="hljs-variable">$DATABASE</span>/_changes?filter=<span class="hljs-variable">$DESIGN_ID</span>/<span class="hljs-variable">$FILTER_FUNCTION</span>&amp;status=new"</span> \
    -u <span class="hljs-string">"<span class="hljs-variable">$USERNAME</span>:<span class="hljs-variable">$PASSWORD</span>"</span>
</code></pre>
  <p><em>Example filter using a supplied <code>req</code> argument:</em></p>
  <pre class="codeblock"><code class="lang-javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">doc, req</span>)</span>{
    <span class="hljs-comment">// we need only `mail` documents</span>
    <span class="hljs-keyword">if</span> (doc.type != <span class="hljs-string">'mail'</span>){
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    <span class="hljs-comment">// we're interested only in `new` ones</span>
    <span class="hljs-keyword">if</span> (doc.status != req.query.status){
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// passed!</span>
}
</code></pre>
  <h3 id="predefined-filter-functions">Predefined filter functions</h3>
  <p>A number of predefined filter functions are available:</p>
  <ul>
    <li><a href="#the-_design-filter"><code>_design</code></a>: accepts only changes to design documents.</li>
    <li><a href="#the-_doc_ids-filter"><code>_doc_ids</code></a>: accepts only changes for documents whose ID is specified in the <code>doc_ids</code> parameter or supplied JSON document.</li>
    <li><a href="#the-_selector-filter"><code>_selector</code></a>: accepts only changes for documents which match a specified selector, defined using the same <a href="cloudant_query.html#selector-syntax">selector syntax</a> used for <a href="cloudant_query.html#finding-documents-using-an-index"><code>_find</code></a>.</li>
    <li><a href="#the-_view-filter"><code>_view</code></a>: allows you to use an existing <a href="creating_views.html#a-simple-view">map function</a> as the filter.</li>
  </ul>
  <h4 id="the-_design-filter">The <code>_design</code> filter</h4>
  <p>The <code>_design</code> filter accepts changes only for design documents within the requested database.</p>
  <p>The filter does not require any arguments.</p>
  <p>Changes are listed for <em>all</em> the design documents within the database.</p>
  <p><em>Example application of the <code>_design</code> filter, using HTTP:</em></p>
  <pre class="codeblock"><code class="lang-http hljs"><span class="hljs-keyword">GET</span> <span class="hljs-string">/$DATABASE/_changes?filter=_design</span> HTTP/1.1
</code></pre>
  <p><em>Example application of the <code>_design</code> filter, using the command line:</em></p>
  <pre class="codeblock"><code class="lang-sh hljs">curl <span class="hljs-string">"https://<span class="hljs-variable">$ACCOUNT</span>.cloudant.com/<span class="hljs-variable">$DATABASE</span>/_changes?filter=_design"</span> \
     -u <span class="hljs-string">"<span class="hljs-variable">$USERNAME</span>:<span class="hljs-variable">$PASSWORD</span>"</span>
</code></pre>
  <p><em>Example response (abbreviated) after applying the <code>_design</code> filter:</em></p>
  <pre class="codeblock"><code class="lang-json hljs">{
    ...
    &quot;results&quot;: [
        {
            &quot;changes&quot;: [
                {
                    &quot;rev&quot;: &quot;10-304...4b2&quot;
                }
            ],
            &quot;id&quot;: &quot;_design/ingredients&quot;,
            &quot;seq&quot;: &quot;8-g1A...gEo&quot;
        },
        {
            &quot;changes&quot;: [
                {
                  &quot;rev&quot;: &quot;123-6f7...817&quot;
                }
            ],
            &quot;deleted&quot;: true,
            &quot;id&quot;: &quot;_design/cookbook&quot;,
            &quot;seq&quot;: &quot;9-g1A...4BL&quot;
        },
        ...
    ]
}
</code></pre>
  <h4 id="the-_doc_ids-filter">The <code>_doc_ids</code> filter</h4>
  <p>The <code>_doc-ids</code> filter accepts only changes for documents with specified IDs. The IDs are specified in a <code>doc_ids</code> parameter, or within a JSON document supplied as part of the original request.</p>
  <p><em>Example application of the <code>_doc_ids</code> filter, using HTTP:</em></p>
  <pre class="codeblock"><code class="lang-http hljs"><span class="hljs-keyword">POST</span> <span class="hljs-string">/$DATABASE/_changes?filter=_doc_ids</span> HTTP/1.1
</code></pre>
  <p><em>Example application of the <code>_doc_ids</code> filter, using the command line:</em></p>
  <pre class="codeblock"><code class="lang-sh hljs">curl <span class="hljs-string">"https://<span class="hljs-variable">$ACCOUNT</span>.cloudant.com/<span class="hljs-variable">$DATABASE</span>/_changes?filter=_doc_ids"</span> \
     -u <span class="hljs-string">"<span class="hljs-variable">$USERNAME</span>:<span class="hljs-variable">$PASSWORD</span>"</span>
</code></pre>
  <p><em>Example JSON document listing document IDs to match during filtering:</em></p>
  <pre class="codeblock"><code class="lang-json hljs">{
    <span class="hljs-attr">"doc_ids"</span>: [
      <span class="hljs-string">"ExampleID"</span>
    ]
}
</code></pre>
  <p><em>Example response (abbreviated) after filtering by <code>_docs_ids</code>:</em></p>
  <pre class="codeblock"><code class="lang-json hljs">{
    <span class="hljs-attr">"last_seq"</span>: <span class="hljs-string">"5-g1A...o5i"</span>,
    <span class="hljs-attr">"pending"</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">"results"</span>: [
        {
            <span class="hljs-attr">"changes"</span>: [
                {
                  <span class="hljs-attr">"rev"</span>: <span class="hljs-string">"13-bcb...29e"</span>
                }
            ],
            <span class="hljs-attr">"id"</span>: <span class="hljs-string">"ExampleID"</span>,
            <span class="hljs-attr">"seq"</span>:  <span class="hljs-string">"5-g1A...HaA"</span>
        }
    ]
}
</code></pre>
  <h4 id="the-_selector-filter">The <code>_selector</code> filter</h4>
  <p>The <code>_selector</code> filter accepts only changes for documents which match a specified selector, defined using the same <a href="cloudant_query.html#selector-syntax">selector syntax</a> used for <a href="cloudant_query.html#finding-documents-using-an-index"><code>_find</code></a>.</p>
  <p>For more examples showing use of this filter, see the information on <a href="cloudant_query.html#selector-syntax">selector syntax</a>.</p>
  <p><em>Example application of the <code>_selector</code> filter, using HTTP:</em></p>
  <pre class="codeblock"><code class="lang-http hljs"><span class="hljs-keyword">POST</span> <span class="hljs-string">/$DATABASE/_changes?filter=_selector</span> HTTP/1.1
</code></pre>
  <p><em>Example application of the <code>_selector</code> filter, using the command line:</em></p>
  <pre class="codeblock"><code class="lang-sh hljs">curl <span class="hljs-string">"https://<span class="hljs-variable">$ACCOUNT</span>.cloudant.com/<span class="hljs-variable">$DATABASE</span>/_changes?filter=_selector"</span> \
     -u <span class="hljs-string">"<span class="hljs-variable">$USERNAME</span>:<span class="hljs-variable">$PASSWORD</span>"</span>
</code></pre>
  <p><em>Example JSON document containing the selector expression to use during filtering:</em></p>
  <pre class="codeblock"><code class="lang-json hljs">{
    <span class="hljs-attr">"selector"</span>: {
        <span class="hljs-attr">"_id"</span>: {
          <span class="hljs-attr">"$regex"</span>: <span class="hljs-string">"^_design/"</span>
        }
    }
}
</code></pre>
  <p><em>Example response (abbreviated) after filtering using a selector:</em></p>
  <pre class="codeblock"><code class="lang-json hljs">{
    <span class="hljs-attr">"last_seq"</span>: <span class="hljs-string">"11-g1A...OaA"</span>,
    <span class="hljs-attr">"pending"</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">"results"</span>: [
        {
            <span class="hljs-attr">"changes"</span>: [
                {
                  <span class="hljs-attr">"rev"</span>: <span class="hljs-string">"10-304...4b2"</span>
                }
            ],
            <span class="hljs-attr">"id"</span>: <span class="hljs-string">"_design/ingredients"</span>,
            <span class="hljs-attr">"seq"</span>: <span class="hljs-string">"8-g1A...gEo"</span>
        },
        {
            <span class="hljs-attr">"changes"</span>: [
                {
                  <span class="hljs-attr">"rev"</span>: <span class="hljs-string">"123-6f7...817"</span>
                }
            ],
            <span class="hljs-attr">"deleted"</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">"id"</span>: <span class="hljs-string">"_design/cookbook"</span>,
            <span class="hljs-attr">"seq"</span>: <span class="hljs-string">"9-g1A...4BL"</span>
        },
        {
            <span class="hljs-attr">"changes"</span>: [
                {
                  <span class="hljs-attr">"rev"</span>: <span class="hljs-string">"6-5b8...8f3"</span>
                }
            ],
            <span class="hljs-attr">"deleted"</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">"id"</span>: <span class="hljs-string">"_design/meta"</span>,
            <span class="hljs-attr">"seq"</span>: <span class="hljs-string">"11-g1A...Hbg"</span>
        }
    ]
}
</code></pre>
  <h4 id="the-_view-filter">The <code>_view</code> filter</h4>
  <p>The <code>_view</code> filter allows you to use an existing <a href="creating_views.html#a-simple-view">map function</a> as the filter.</p>
  <p>If the map function emits any output as a result of processing a given document, then the filter considers the document to be allowed and so includes it in the list of documents that have changed.</p>
  <p><em>Example application of the <code>_view</code> filter, using HTTP:</em></p>
  <pre class="codeblock"><code class="lang-http hljs"><span class="hljs-keyword">GET</span> <span class="hljs-string">/$DATABASE/_changes?filter=_view&amp;view=$DESIGNDOC/$VIEWNAME</span> HTTP/1.1
</code></pre>
  <p><em>Example application of the <code>_view</code> filter, using the command line:</em></p>
  <pre class="codeblock"><code class="lang-sh hljs">curl <span class="hljs-string">"https://<span class="hljs-variable">$ACCOUNT</span>.cloudant.com/<span class="hljs-variable">$DATABASE</span>/_changes?filter=_view&amp;view=<span class="hljs-variable">$DESIGNDOC</span>/<span class="hljs-variable">$VIEWNAME</span>"</span> \
     -u <span class="hljs-string">"<span class="hljs-variable">$USERNAME</span>:<span class="hljs-variable">$PASSWORD</span>"</span>
</code></pre>
  <p><em>Example response (abbreviated) after filtering using a map function:</em></p>
  <pre class="codeblock"><code class="lang-json hljs">{
    <span class="hljs-attr">"last_seq"</span>: <span class="hljs-string">"5-g1A...o5i"</span>,
    <span class="hljs-attr">"results"</span>: [
        {
            <span class="hljs-attr">"changes"</span>: [
                {
                  <span class="hljs-attr">"rev"</span>: <span class="hljs-string">"13-bcb...29e"</span>
                }
            ],
            <span class="hljs-attr">"id"</span>: <span class="hljs-string">"ExampleID"</span>,
            <span class="hljs-attr">"seq"</span>:  <span class="hljs-string">"5-g1A...HaA"</span>
        }
    ]
}
</code></pre>
  <h2 id="update-validators">Update Validators</h2>
  <p>Update validators determine whether a document should be written to disk when insertions and updates are attempted. They do not require a query because they implicitly run during this process. If a change is rejected, the update validator responds with
    a custom error.</p>
  <p>Update validators require four arguments:</p>
  <table>
    <thead>
      <tr>
        <th>Argument</th>
        <th>Purpose</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><code>newDoc</code></td>
        <td>The version of the document passed in the request.</td>
      </tr>
      <tr>
        <td><code>oldDoc</code></td>
        <td>The version of the document currently in the database, or <code>null</code> if there is none.</td>
      </tr>
      <tr>
        <td><code>secObj</code></td>
        <td>The <a href="authorization.html#viewing-permissions">security object</a> for the database.</td>
      </tr>
      <tr>
        <td><code>userCtx</code></td>
        <td>Context regardingthe currently authenticated user, such as <code>name</code> and <code>roles</code>.</td>
      </tr>
    </tbody>
  </table>
  <blockquote>
    <p> <strong>Note</strong>: Update validators do not apply when a design document is updated by an admin user. This is to ensure that admins can never accidentally lock themselves out.</p>
  </blockquote>
  <p><em>Example design document with an update validator:</em></p>
  <pre class="codeblock"><code class="lang-json hljs">{
    <span class="hljs-attr">"_id"</span>: <span class="hljs-string">"_design/validator_example"</span>,
    <span class="hljs-attr">"validate_doc_update"</span>: <span class="hljs-string">"function(newDoc, oldDoc, userCtx, secObj) { ... }"</span>
}
</code></pre>
  <p><em>Example of an update validator:</em></p>
  <pre class="codeblock"><code class="lang-javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">newDoc, oldDoc, userCtx, secObj</span>) </span>{
    <span class="hljs-keyword">if</span> (newDoc.address === <span class="hljs-literal">undefined</span>) {
        <span class="hljs-keyword">throw</span>({<span class="hljs-attr">forbidden</span>: <span class="hljs-string">'Document must have an address.'</span>});
    }
}
</code></pre>
  <p><em>Example response from an update validator:</em></p>
  <pre class="codeblock"><code class="lang-json hljs">{
    <span class="hljs-attr">"error"</span>: <span class="hljs-string">"forbidden"</span>,
    <span class="hljs-attr">"reason"</span>: <span class="hljs-string">"Document must have an address."</span>
}
</code></pre>
  <h2 id="retrieving-information-about-a-design-document">Retrieving information about a design document</h2>
  <p>There are two endpoints available that provide you with more information about design documents: <a href="#the-_info-endpoint"><code>_info</code></a> and <a href="#the-_search_info-endpoint"><code>_search_info</code></a>.</p>
  <h3 id="the-_info-endpoint">The <code>_info</code> endpoint</h3>
  <p>The <code>_info</code> endpoint returns information about a given design document, including the index, index size, and current status of the design document and associated index information.</p>
  <ul>
    <li><strong>Method</strong>: <code>GET /db/_design/design-doc/_info</code></li>
    <li><strong>Request</strong>: None</li>
    <li><strong>Response</strong>: JSON containing the design document information.</li>
    <li><strong>Roles permitted</strong>: <code>_reader</code></li>
  </ul>
  <p><em>Example of retrieving information about the <code>recipesdd</code> design document from within the <code>recipes</code> database,
using HTTP:</em></p>
  <pre class="codeblock"><code class="lang-http hljs"><span class="hljs-keyword">GET</span> <span class="hljs-string">/recipes/_design/recipesdd/_info</span> HTTP/1.1
</code></pre>
  <p><em>Example of retrieving information about the <code>recipesdd</code> design document from within the <code>recipes</code> database,
using the command line:</em></p>
  <pre class="codeblock"><code class="lang-sh hljs">curl <span class="hljs-string">"https://<span class="hljs-variable">$ACCOUNT</span>.cloudant.com/recipes/_design/recipesdd/_info"</span> \
     -u <span class="hljs-string">"<span class="hljs-variable">$USERNAME</span>:<span class="hljs-variable">$PASSWORD</span>"</span>
</code></pre>
  <p>The individual fields in the JSON response are as follows:</p>
  <ul>
    <li><strong>name</strong>: Name or ID of Design Document.</li>
    <li><strong>view_index</strong>: View Index
      <ul>
        <li><strong>compact_running</strong>: Indicates whether a compaction routine is currently running on the view.</li>
        <li><strong>disk_size</strong>: Size in bytes of the view as stored on disk.</li>
        <li><strong>language</strong>: Language used for defining views.</li>
        <li><strong>purge_seq</strong>: The purge sequence that has been processed.</li>
        <li><strong>signature</strong>: MD5 signature of the views for the design document.</li>
        <li><strong>update_seq</strong>: The update sequence of the corresponding database that has been indexed.</li>
        <li><strong>updater_running</strong>: Indicates if the view is currently being updated.</li>
        <li><strong>waiting_clients</strong>: Number of clients waiting on views from this design document.</li>
        <li><strong>waiting_commit</strong>: Indicates if there are outstanding commits to the underlying database that need to processed</li>
      </ul>
    </li>
  </ul>
  <p><em>Example response in JSON format:</em></p>
  <pre class="codeblock"><code class="lang-json hljs">{
    <span class="hljs-attr">"name"</span> : <span class="hljs-string">"recipesdd"</span>,
    <span class="hljs-attr">"view_index"</span>: {
        <span class="hljs-attr">"compact_running"</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">"updater_running"</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">"language"</span>: <span class="hljs-string">"javascript"</span>,
        <span class="hljs-attr">"purge_seq"</span>: <span class="hljs-number">10</span>,
        <span class="hljs-attr">"waiting_commit"</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">"waiting_clients"</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">"signature"</span>: <span class="hljs-string">"fc65594ee76087a3b8c726caf5b40687"</span>,
        <span class="hljs-attr">"update_seq"</span>: <span class="hljs-number">375031</span>,
        <span class="hljs-attr">"disk_size"</span>: <span class="hljs-number">16491</span>
    }
}
</code></pre>
  <h3 id="the-_search_info-endpoint">The <code>_search_info</code> endpoint</h3>
  <p>The <code>_search_info</code> endpoint returns information about a specified search that is defined within a given design document.</p>
  <ul>
    <li><strong>Method</strong>: <code>GET /db/_design/design-doc/_search_info/yourSearch</code></li>
    <li><strong>Request</strong>: None</li>
    <li><strong>Response</strong>: JSON containing information about the specified search.</li>
    <li><strong>Roles permitted</strong>: <code>_reader</code></li>
  </ul>
  <p><em>Example of getting information about the <code>description</code> search,
defined within the <code>app</code> design document stored in the <code>foundbite</code> database, using HTTP:</em></p>
  <pre class="codeblock"><code class="lang-http hljs"><span class="hljs-keyword">GET</span> <span class="hljs-string">/foundbite/_design/app/_search_info/description</span> HTTP/1.1
</code></pre>
  <p><em>Example of getting information about the <code>description</code> search,
defined within the <code>app</code> design document stored in the <code>foundbite</code> database, using the command line:</em></p>
  <pre class="codeblock"><code class="lang-sh hljs">curl <span class="hljs-string">"https://<span class="hljs-variable">$USERNAME</span>.cloudant.com/foundbite/_design/app/_search_info/description"</span> \
    -u <span class="hljs-string">"<span class="hljs-variable">$USERNAME</span>:<span class="hljs-variable">$PASSWORD</span>"</span>
</code></pre>
  <p>The individual fields in the returned JSON structure are as follows:</p>
  <ul>
    <li><strong>name</strong>: Name or ID of the Search within the Design Document.</li>
    <li><strong>search_index</strong>: The Search Index
      <ul>
        <li><strong>pending_seq</strong>: The sequence number of changes in the database that have reached the Lucene index, both in memory and on disk.</li>
        <li><strong>doc_del_count</strong>: Number of deleted documents in the index.</li>
        <li><strong>doc_count</strong>: Number of documents in the index.</li>
        <li><strong>disk_size</strong>: The size of the index on disk, in bytes.</li>
        <li><strong>committed_seq</strong>: The sequence number of changes in the database that have been committed to the Lucene index on disk.</li>
      </ul>
    </li>
  </ul>
  <p><em>Example response in JSON format:</em></p>
  <pre class="codeblock"><code class="lang-json hljs">{
    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"_design/app/description"</span>,
    <span class="hljs-attr">"search_index"</span>: {
        <span class="hljs-attr">"pending_seq"</span>: <span class="hljs-number">63</span>,
        <span class="hljs-attr">"doc_del_count"</span>: <span class="hljs-number">3</span>,
        <span class="hljs-attr">"doc_count"</span>: <span class="hljs-number">10</span>,
        <span class="hljs-attr">"disk_size"</span>: <span class="hljs-number">9244</span>,
        <span class="hljs-attr">"committed_seq"</span>: <span class="hljs-number">63</span>
    }
}
</code></pre>
  <footer>
    <div>
      <p>Copyright &copy; 2015, 2017. All Rights Reserved.</p>
    </div>
  </footer>
</body>
</html>