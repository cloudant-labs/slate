<html lang="en">
<head>
  <title>IBM&reg; Cloudant&reg; NoSQL DB for Bluemix&reg;</title>
  <meta charset="utf-8"></meta>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"></meta>
  <meta name="viewport" content="width=device-width, initial-scale=1"></meta>
</head>

<body>
  <h1 id="managing-tasks">Managing tasks</h1>
  <p class="shortdesc">Creating new indexes over lots of data or replicating a large database can take quite a while.</p>
  <p>So how can you determine whether your tasks are making progress, or if they have completed? The <a href="../api/active_tasks.html"><code>_active_tasks</code> endpoint</a> provides information about all ongoing tasks. However, if you start a lot of tasks,
    some of them might be scheduled to run later and do not show up under <code>_active_tasks</code> until they have been started.</p>
  <p>This guide tells you how to use the <code>_active_tasks</code> endpoint to monitor long-running tasks. The <code>curl</code> command is used to access the endpoint. The <code>jq</code> command-line JSON processor is used to process the JSON response.</p>
  <p>Since this is a task-focused tutorial, it covers only what is essential to accomplish this task. Please refer to the <a href="../api/index.html">API reference</a> for a complete guide to the available options.</p>
  <h2 id="curl-and-jq-basics">curl and jq basics</h2>
  <p>To get all active tasks and format the output nicely, call your account using <code>curl</code>, and pipe the output to <code>jq</code>.</p>
  <p><code>jq</code> lets you filter a list of documents by their field values. This makes it easier to get all replication documents, or the details of just one particular view indexing task. The <a href="../api/index.html">API reference</a> has more information
    about the options.</p>
  <p><em>Example of obtaining and formatting a list of active tasks:</em></p>
  <pre class="codeblock"><code class="lang-sh hljs">curl <span class="hljs-string">'https://username:password@username.cloudant.com/_active_tasks'</span> | jq <span class="hljs-string">'.'</span>
</code></pre>
  <h2 id="monitoring-view-builds-and-search-indexes">Monitoring view builds and search indexes</h2>
  <p>View indexes are rebuilt when a design document is updated. An update to any one of the views causes all the views in the document to be rebuilt.</p>
  <p>Search indexes are rebuilt only when their corresponding index function is changed. For each search index that is being built and for each design document with views that are changed, a new task is created for each replica of each shard in a cluster.</p>
  <p>For example, if there are 24 shards, with three replicas each, and you update two search indexes, then 24 x 3 x 2 = 144 tasks are run.</p>
  <p>To find all the view indexing tasks, pipe the <code>curl</code> output to <code>jq</code>, and let it filter the documents in the array by their type field. A corresponding command works for search indexing tasks.</p>
  <p>In each case, the results of searching for a list of indexing tasks is a list of JSON objects: one for each of the active tasks found.</p>
  <p><em>Example of finding all view indexing tasks by filtering for the <code>indexer</code> type:</em></p>
  <pre class="codeblock"><code class="lang-sh hljs">curl <span class="hljs-_">-s</span> <span class="hljs-string">'https://username:password@username.cloudant.com/_active_tasks'</span> | jq <span class="hljs-string">'.[] | select(.type=="indexer")'</span>
</code></pre>
  <p><em>Example of finding all search indexing tasks by filtering for the <code>search_indexer</code> type:</em></p>
  <pre class="codeblock"><code class="lang-sh hljs">curl <span class="hljs-_">-s</span> <span class="hljs-string">'https://username:password@username.cloudant.com/_active_tasks'</span> | jq <span class="hljs-string">'.[] | select(.type=="search_indexer")'</span>
</code></pre>
  <p><em>Example results after searching for view indexing tasks:</em></p>
  <pre class="codeblock"><code class="lang-json hljs">{
    <span class="hljs-attr">"total_changes"</span>: <span class="hljs-number">6435</span>,
    <span class="hljs-attr">"started_on"</span>: <span class="hljs-number">1371118332</span>,
    <span class="hljs-attr">"user"</span>: <span class="hljs-string">"username"</span>,
    <span class="hljs-attr">"updated_on"</span>: <span class="hljs-number">1371118334</span>,
    <span class="hljs-attr">"type"</span>: <span class="hljs-string">"indexer"</span>,
    <span class="hljs-attr">"node"</span>: <span class="hljs-string">"dbcore@db6.meritage.cloudant.net"</span>,
    <span class="hljs-attr">"pid"</span>: <span class="hljs-string">"&lt;0.16366.6103&gt;"</span>,
    <span class="hljs-attr">"changes_done"</span>: <span class="hljs-number">364</span>,
    <span class="hljs-attr">"database"</span>: <span class="hljs-string">"shards/40000000-7fffffff/username/database"</span>,
    <span class="hljs-attr">"design_document"</span>: <span class="hljs-string">"_design/ngrams"</span>
}
</code></pre>
  <h2 id="estimating-the-time-to-complete-a-task">Estimating the time to complete a task</h2>
  <p>To estimate the time needed until the indexing task is complete, monitor the number of <code>changes_done</code> and compare this value to <code>total_changes</code>. For example, if <code>changes_done</code> advances by 250 per second, and <code>total_changes</code>    is 1,000,000, the task is expected to take 1,000,000 / 250 = 4,000 seconds, or about 66 minutes,to complete.</p>
  <blockquote>
    <p> <strong>Note</strong>: Estimates of the time to complete an indexing task cannot be 100% accurate. The actual time to complete the task depends on several factors, including:
    </p>
  </blockquote>
  <ul>
    <li>The time it takes to process each document. For instance, a view might check the type of a document first, and only emit new index entries for one type.</li>
    <li>The size of the documents.</li>
    <li>The current workload on the cluster.</li>
  </ul>
  <blockquote>
    <p> You should assume that these factors might combine to produce considerable inaccuracy in your estimate.</p>
  </blockquote>
  <p><em>Example of extracting the <code>changes_done</code> field using <code>jq</code>:</em></p>
  <pre class="codeblock"><code class="lang-sh hljs">curl ... | jq <span class="hljs-string">'.[] | select(.type=="search_indexer") | .changes_done'</span>
</code></pre>
  <h2 id="monitoring-replication">Monitoring replication</h2>
  <p>To find all replication tasks, pipe the <code>curl</code> output to <code>jq</code>, and filter the documents in the array by their type field.</p>
  <p>To make it easier to select the information about a replication process from the list of active tasks, start the replication process by creating a document in the <code>_replicator</code> database, and set its <code>_id</code> field to a known value.</p>
  <p><em>Example of finding all replication tasks, by filtering for the <code>replication</code> type:</em></p>
  <pre class="codeblock"><code class="lang-sh hljs">curl <span class="hljs-_">-s</span> <span class="hljs-string">'https://username:password@username.cloudant.com/_active_tasks'</span> | jq <span class="hljs-string">'.[] | select(.type=="replication")'</span>
</code></pre>
  <p><em>Example of finding a specific replication task, by filtering for a known document identity:</em></p>
  <pre class="codeblock"><code class="lang-sh hljs">curl ... | jq <span class="hljs-string">'.[] | select(.doc_id=="ID")'</span>
</code></pre>
  <p><em>Example of finding a specific replication task, by filtering for a known <code>replication_id</code>:</em></p>
  <pre class="codeblock"><code class="lang-sh hljs">curl ... | jq <span class="hljs-string">'.[] | select(.replication_id=="ID")'</span>
</code></pre>
  <p><em>Example result after searching for a replication task:</em></p>
  <pre class="codeblock"><code class="lang-json hljs">{
    <span class="hljs-attr">"started_on"</span>: <span class="hljs-number">1371094220</span>,
    <span class="hljs-attr">"source_seq"</span>: <span class="hljs-string">"62960-sakdjflksdfjsdlkafjalskdfjlsakfjlasdkjksald"</span>,
    <span class="hljs-attr">"source"</span>: <span class="hljs-string">""</span>,
    <span class="hljs-attr">"revisions_checked"</span>: <span class="hljs-number">12</span>,
    <span class="hljs-attr">"continuous"</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">"doc_id"</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">"doc_write_failures"</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">"docs_read"</span>: <span class="hljs-number">12</span>,
    <span class="hljs-attr">"target"</span>: <span class="hljs-string">""</span>,
    <span class="hljs-attr">"type"</span>: <span class="hljs-string">"replication"</span>,
    <span class="hljs-attr">"updated_on"</span>: <span class="hljs-number">1371118477</span>,
    <span class="hljs-attr">"user"</span>: <span class="hljs-string">"username"</span>,
    <span class="hljs-attr">"checkpointed_source_seq"</span>: <span class="hljs-string">"61764-dskfjalsfjsalkfjssadjfhasdfkjhsdkfhsdkf"</span>,
    <span class="hljs-attr">"changes_pending"</span>: <span class="hljs-number">1196</span>,
    <span class="hljs-attr">"pid"</span>: <span class="hljs-string">"&lt;0.9955.4120&gt;"</span>,
    <span class="hljs-attr">"node"</span>: <span class="hljs-string">"dbcore@db7.meritage.cloudant.net"</span>,
    <span class="hljs-attr">"docs_written"</span>: <span class="hljs-number">12</span>,
    <span class="hljs-attr">"missing_revisions_found"</span>: <span class="hljs-number">12</span>,
    <span class="hljs-attr">"replication_id"</span>: <span class="hljs-string">"asfksdlfkjsadkfjsdalkfjas+continuous+create_target"</span>
}
</code></pre>
  <h2 id="troubleshooting">Troubleshooting</h2>
  <h3 id="is-a-task-stuck-">Is a task stuck?</h3>
  <p>For a one-off, non-continuous replication, where the source database is not updated significantly during the replication, the <code>changes_pending</code> value tells you how many documents remain to be processed. This means that the <code>changes_pending</code>    value is good indicator of when the replication is likely to be finished.</p>
  <p>For a continuous replication, you are more interested in how the number of documents processed changes over time, and whether the <code>changes_pending</code> value increases. If <code>changes_pending</code> increases, but <code>revisions_checked</code>    stays constant for a while, the replication is probably stalled. If <code>changes_pending</code> increases, and <code>revisions_checked</code> also increases, this might indicate that the replication cannot keep up with the volume of data added to,
    or updated in, the database.</p>
  <h3 id="what-to-do-about-a-stuck-task-">What to do about a stuck task?</h3>
  <p>To resolve a stalled replication, you might have to <a href="../api/replication.html#cancelling-a-replication">cancel the replication process</a> and start it again.</p>
  <p>If that does not help, the replication might be stalled because the user accessing the source or target databases does not have write permissions.</p>
  <blockquote>
    <p> <strong>Note</strong>: Replication makes use of <a href="replication_guide.html#checkpoints">checkpoints</a>. This means that content already replicated and unchanged does not have to be replicated again if the replication is restarted.</p>
  </blockquote>
  <p>If you created the replication process by creating a document in the <code>_replicator</code> database, you can also check the status of the replication there.</p>
  <footer>
    <div>
      <p>Copyright &copy; 2015, 2017. All Rights Reserved.</p>
    </div>
  </footer>
</body>
</html>