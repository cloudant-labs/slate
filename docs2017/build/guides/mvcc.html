<html lang="en">
<head>
  <title>IBM&reg; Cloudant&reg; NoSQL DB for Bluemix&reg;</title>
  <meta charset="utf-8"></meta>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"></meta>
  <meta name="viewport" content="width=device-width, initial-scale=1"></meta>
</head>

<body>
  <h1 id="document-versioning-and-mvcc">Document Versioning and MVCC</h1>
  <p class="shortdesc"><a href="https://en.wikipedia.org/wiki/Multiversion_concurrency_control" target="_blank">Multi-version concurrency control (MVCC) <img src="../images/launch-glyph.svg" alt="External link icon" title="External link icon"></a> is how Cloudant databases
    ensure that all of the nodes in a database&#39;s cluster contain only the <a href="../api/document.html">newest version</a> of a document.</p>
  <p>Since Cloudant databases are <a href="cap_theorem.html">eventually consistent</a>, this is necessary to prevent inconsistencies arising between nodes as a result of synchronizing between outdated documents.</p>
  <p>Multi-Version Concurrency Control (MVCC) enables concurrent read and write access to a Cloudant database. MVCC is a form of <a href="http://en.wikipedia.org/wiki/Optimistic_concurrency_control" target="_blank">optimistic concurrency <img src="../images/launch-glyph.svg" alt="External link icon" title="External link icon"></a>.
    It makes both read and write operations on Cloudant databases faster because there is no need for database locking on either read or write operations. MVCC also enables synchronization between Cloudant database nodes.</p>
  <h2 id="revisions">Revisions</h2>
  <p>Every document in a Cloudant database has a <code>_rev</code> field indicating its revision number.</p>
  <p>A revision number is added to your documents by the server when you insert or modify them. The number is included in the server response when you make changes or read a document. The <code>_rev</code> value is constructed using a combination of a simple
    counter and a hash of the document.</p>
  <p>The two main uses of the revision number are to help:</p>
  <ol>
    <li>Determine what documents must be replicated between servers.</li>
    <li>Confirm that a client is trying to modify the latest version of a document.</li>
  </ol>
  <p>You must specify the previous <code>_rev</code> when <a href="../api/document.html#update">updating a document</a> or else your request fails and returns a <a href="../api/http.html#409">409 error</a>.</p>
  <blockquote>
    <p> <strong>Note</strong>: <code>_rev</code> should not be used to build a version control system. The reason is that it is an internal value used by the server. In addition, older revisions of a document are transient, and therefore removed regularly.</p>
  </blockquote>
  <p>You can query a particular revision using its <code>_rev</code>, however, older revisions are regularly deleted by a process called
    <a href="http://en.wikipedia.org/wiki/Data_compaction" target="_blank">compaction <img src="../images/launch-glyph.svg" alt="External link icon" title="External link icon"></a>. A consequence of compaction is that you cannot rely on a successful response
    when querying a particular document revision using its <code>_rev</code> in order to obtain a history of revisions to your document. If you need a version history of your documents, a solution is to <a href="../api/document.html#documentCreate">create a new document</a>    for each revision.</p>
  <h2 id="distributed-databases-and-conflicts">Distributed Databases and Conflicts</h2>
  <p>Distributed databases work without a constant connection to the main database on Cloudant, which is itself distributed, so updates based on the same previous version can still be in conflict.</p>
  <p>To find conflicts, add the query parameter <a href="../api/database.html#get-changes"><code>conflicts=true</code></a> when retrieving a document. The response contains a <code>_conflicts</code> array with all conflicting revisions.</p>
  <p>To find conflicts for multiple documents in a database, write a view.</p>
  <p>The following map function is is an example that emits all conflicting revisions for every document that has a conflict.</p>
  <p><em>Example of a map function to find documents with a conflict:</em></p>
  <pre class="codeblock"><code class="lang-javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">doc</span>) </span>{
    <span class="hljs-keyword">if</span> (doc._conflicts) {
        emit(<span class="hljs-literal">null</span>, [doc._rev].concat(doc._conflicts));
    }
}
</code></pre>
  <p>You could regularly query this view and resolve conflicts as needed, or query the view after each replication.</p>
  <h2 id="how-to-resolve-conflicts">How to resolve conflicts</h2>
  <p>Once you&#39;ve found a conflict, you can resolve it in 4 steps.</p>
  <ol>
    <li><a href="#get-conflicting-revisions">Get</a> the conflicting revisions.</li>
    <li><a href="#merge-the-changes">Merge</a> them in your application or ask the user what he wants to do.</li>
    <li><a href="#upload-the-new-revision">Upload</a> the new revision.</li>
    <li><a href="#delete-old-revisions">Delete</a> old revisions.</li>
  </ol>
  <p>Let&#39;s consider an example of how this can be done. Suppose you have a database of products for an online shop. The first version of a document might look like the following example:</p>
  <pre class="codeblock"><code class="lang-json hljs">{
    <span class="hljs-attr">"_id"</span>: <span class="hljs-string">"74b2be56045bed0c8c9d24b939000dbe"</span>,
    <span class="hljs-attr">"_rev"</span>: <span class="hljs-string">"1-7438df87b632b312c53a08361a7c3299"</span>,
    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Samsung Galaxy S4"</span>,
    <span class="hljs-attr">"description"</span>: <span class="hljs-string">""</span>,
    <span class="hljs-attr">"price"</span>: <span class="hljs-number">650</span>
}
</code></pre>
  <p>As the document doesn&#39;t have a description yet, someone might add one:</p>
  <p><em>Second version of the document, created by adding a description:</em></p>
  <pre class="codeblock"><code class="lang-json hljs">{
    <span class="hljs-attr">"_id"</span>: <span class="hljs-string">"74b2be56045bed0c8c9d24b939000dbe"</span>,
    <span class="hljs-attr">"_rev"</span>: <span class="hljs-string">"2-61ae00e029d4f5edd2981841243ded13"</span>,
    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Samsung Galaxy S4"</span>,
    <span class="hljs-attr">"description"</span>: <span class="hljs-string">"Latest smartphone from Samsung"</span>,
    <span class="hljs-attr">"price"</span>: <span class="hljs-number">650</span>
}
</code></pre>
  <p>At the same time, someone else - working with a replicated database - reduces the price:</p>
  <p><em>A different revision, conflicting with the previous one, because of different <code>price</code> value:</em></p>
  <pre class="codeblock"><code class="lang-json hljs">{
    <span class="hljs-attr">"_id"</span>: <span class="hljs-string">"74b2be56045bed0c8c9d24b939000dbe"</span>,
    <span class="hljs-attr">"_rev"</span>: <span class="hljs-string">"2-f796915a291b37254f6df8f6f3389121"</span>,
    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Samsung Galaxy S4"</span>,
    <span class="hljs-attr">"description"</span>: <span class="hljs-string">""</span>,
    <span class="hljs-attr">"price"</span>: <span class="hljs-number">600</span>
}
</code></pre>
  <p>The two databases are then replicated. The difference in document versions results in a conflict.</p>
  <h3 id="get-conflicting-revisions">Get conflicting revisions</h3>
  <p>You identify documents with with conflicts by using the <code>conflicts=true</code> option.</p>
  <p><em>Example of finding documents with conflicts:</em></p>
  <pre class="codeblock"><code class="lang-http hljs">http://$USERNAME.cloudant.com/products/$_ID?conflicts=true
</code></pre>
  <p><em>Example response showing conflicting revisions affecting documents:</em></p>
  <pre class="codeblock"><code class="lang-json hljs">{
    <span class="hljs-attr">"_id"</span>:<span class="hljs-string">"74b2be56045bed0c8c9d24b939000dbe"</span>,
    <span class="hljs-attr">"_rev"</span>:<span class="hljs-string">"2-f796915a291b37254f6df8f6f3389121"</span>,
    <span class="hljs-attr">"name"</span>:<span class="hljs-string">"Samsung Galaxy S4"</span>,
    <span class="hljs-attr">"description"</span>:<span class="hljs-string">""</span>,
    <span class="hljs-attr">"price"</span>:<span class="hljs-number">600</span>,
    <span class="hljs-attr">"_conflicts"</span>:[<span class="hljs-string">"2-61ae00e029d4f5edd2981841243ded13"</span>]
}
</code></pre>
  <p>The version with the changed price has been chosen arbitrarily as the latest version of the document and the conflict with another version is noted by providing the ID of that other version in the <code>_conflicts</code> array. In most cases this array
    has only one element, but there might be many conflicting revisions.</p>
  <h3 id="merge-the-changes">Merge the changes</h3>
  <p>To compare the revisions to see what has been changed, your application gets all of the versions from the database.</p>
  <p><em>Example commands to retrieve all versions of a document from the database:</em></p>
  <pre class="codeblock"><code class="lang-http hljs">http://$USERNAME.cloudant.com/products/$_ID
http://$USERNAME.cloudant.com/products/$_ID?rev=2-61ae00e029d4f5edd2981841243ded13
http://$USERNAME.cloudant.com/products/$_ID?rev=1-7438df87b632b312c53a08361a7c3299
</code></pre>
  <p>Since the conflicting changes are for different fields of the document, it is easy to merge them.</p>
  <p>For more complex conflicts, other resolution strategies might be required:</p>
  <ul>
    <li>Time based: use the first or last edit.</li>
    <li>User intervention: report conflicts to users and let them decide on the best resolution.</li>
    <li>Sophisticated algorithms: for example, 3-way merges of text fields.</li>
  </ul>
  <p>For a practical example of how to implement a merge of changes, see <a href="https://github.com/glynnbird/deconflict" target="_blank">this project with sample code <img src="../images/launch-glyph.svg" alt="External link icon" title="External link icon"></a>.</p>
  <h3 id="upload-the-new-revision">Upload the new revision</h3>
  <p>The next step is to create a document that resolves the conflicts, and update the database with it.</p>
  <p><em>An example document that merges changes from the two conflicting revisions:</em></p>
  <pre class="codeblock"><code class="lang-json hljs">{
    <span class="hljs-attr">"_id"</span>: <span class="hljs-string">"74b2be56045bed0c8c9d24b939000dbe"</span>,
    <span class="hljs-attr">"_rev"</span>: <span class="hljs-string">"3-daaecd7213301a1ad5493186d6916755"</span>,
    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Samsung Galaxy S4"</span>,
    <span class="hljs-attr">"description"</span>: <span class="hljs-string">"Latest smartphone from Samsung"</span>,
    <span class="hljs-attr">"price"</span>: <span class="hljs-number">600</span>
}
</code></pre>
  <h3 id="delete-old-revisions">Delete old revisions</h3>
  <p>Finally, you delete the old revisions by sending a <code>DELETE</code> request to the URLs with the revision we want to delete.</p>
  <p><em>Example request to delete an old document revision, using HTTP:</em></p>
  <pre class="codeblock"><code class="lang-http hljs">DELETE https://$USERNAME.cloudant.com/products/$_ID?rev=2-61ae00e029d4f5edd2981841243ded13
</code></pre>
  <p><em>Example request to delete an old document revision, using the command line:</em></p>
  <pre class="codeblock"><code class="lang-sh hljs">curl <span class="hljs-string">"https://<span class="hljs-variable">$USERNAME</span>.cloudant.com/products/<span class="hljs-variable">$_ID</span>?rev=2-f796915a291b37254f6df8f6f3389121"</span> -X DELETE
</code></pre>
  <p>At this point, conflicts affecting the document are resolved. You can verify this by <code>GET</code>ting the document again with the <code>conflicts</code> parameter set to <code>true</code>.</p>
  <footer>
    <div>
      <p>Copyright &copy; 2015, 2017. All Rights Reserved.</p>
    </div>
  </footer>
</body>
</html>