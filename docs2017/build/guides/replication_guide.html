<html lang="en">
<head>
  <title>IBM&reg; Cloudant&reg; NoSQL DB for Bluemix&reg;</title>
  <meta charset="utf-8"></meta>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"></meta>
  <meta name="viewport" content="width=device-width, initial-scale=1"></meta>
</head>

<body>
  <!-- Acrolinx: 2017-04-20 -->

  <h1 id="replication">Replication</h1>
  <p class="shortdesc">Data can be copied from one database to another in the same Cloudant account, across accounts and across data centers.</p>
  <p>Data can even be replicated to and from a Cloudant account and a mobile device by using <a href="https://cloudant.com/product/cloudant-features/sync/" target="_blank">Cloudant Sync <img src="../images/launch-glyph.svg" alt="External link icon" title="External link icon"></a>    or <a href="http://pouchdb.com/" target="_blank">PouchDB <img src="../images/launch-glyph.svg" alt="External link icon" title="External link icon"></a>. Replication can run in one direction or in both directions, as a &#39;single shot&#39; or continuous
    operation, and can be finely tuned by using parameters.</p>
  <p>Cloudant’s replication protocol is compatible with a range of other databases and libraries, making it a great fit for Internet of Things (IoT) and mobile applications.</p>
  <p>This guide introduces Cloudant’s replication functions, discusses common use-cases, and shows how to make your application replicate successfully.</p>
  <h2 id="what-is-replication-">What is Replication?</h2>
  <p>Cloudant is a distributed JSON data store with an HTTP API. Cloudant can be run as a service on multiple clouds, or in your server rack. Documents are stored in databases and can grow to any size as Cloudant shards its data across many nodes. Replication
    is the copying of data from a source database to a target database. The source and target databases do not need to be on the same Cloudant account, or even in the same data center.</p>
  <p><img src="../images/replication_guide_1.png" alt="replication"></p>
  <p>Replication is complete when the most recent version of each document in the source transfers to the destination database. Transfers include new documents, updates to existing documents, and deletions. Only the most recent version of a document remains
    after replication; older versions are omitted.</p>
  <p>The source database remains unaltered by replication, apart from checkpoint data that is written to it to allow partial replications to resume from the last known position. Any pre-existing data in the destination database remains.</p>
  <div id="how-do-i-initiate-replication-via-the-dashboard-"></div>
  <h2 id="how-to-start-replication-by-using-the-dashboard">How to start replication by using the Dashboard</h2>
  <p>The Cloudant Dashboard provides a convenient user-interface to trigger replication. Open the Replication tab of your Cloudant Dashboard and click the <code>New Replication</code> action button. Complete the simple form:</p>
  <p><img src="../images/replication_guide_2.png" alt="replication2"></p>
  <p>Using the form, define the source and target databases, then click &quot;<code>Replicate</code>&quot;.</p>
  <p><img src="../images/replication_guide_3.png" alt="replication3"></p>
  <p>The status of each replication task can be seen in the &quot;<code>All Replications</code>&quot; section of the Dashboard. Each job changes state from &quot;<code>Triggered</code>&quot; to &quot;<code>Complete</code>&quot; as it progresses.</p>
  <p><img src="../images/replication_guide_4.png" alt="replication4"></p>
  <div id="how-do-i-run-replication-across-different-cloudant-accounts-"></div>
  <h2 id="how-to-run-replication-across-different-cloudant-accounts">How to run replication across different Cloudant accounts</h2>
  <p>The source and target of a replication are URLs of Cloudant databases, as shown in the following example.</p>
  <p><em>Example of defining source and target URLs for replication:</em></p>
  <pre class="codeblock"><code class="lang-json hljs">{
    <span class="hljs-attr">"source"</span>: <span class="hljs-string">"https://myfirstaccount.cloudant.com/a"</span>,
    <span class="hljs-attr">"target"</span>: <span class="hljs-string">"https://mysecondaccount.cloudant.com/b"</span>
}
</code></pre>
  <p>The source and target do not need to be on the same account. The source and target database names do not need to match. You must be authorized to access both the source and target, and you must be authorized to write to the target.</p>
  <div id="do-i-run-replication-on-the-source-or-the-destination-"></div>
  <h2 id="is-replication-run-on-the-source-or-the-destination-">Is replication run on the source or the destination?</h2>
  <p>Replication can be started at either the source or the destination end. This choice means that you can decide whether account A is pushing data to account B, or account B is pulling data from account A. In some cases, it might not be possible to run
    replication in either configuration, for example when one account is behind a firewall. Replication happens over HTTP or HTTPS and so no non-standard ports need be opened. The decision as to which device starts replication is yours.</p>
  <div id="how-do-i-initiate-replication-via-the-cloudant-api-"></div>
  <h2 id="how-to-start-replication-by-using-the-cloudant-api">How to start replication by using the Cloudant API</h2>
  <p>Every Cloudant account has a special database that is called <code>_replicator</code>, into which replication jobs can be inserted. Add a document into the <code>_replicator</code> database to start replication. The document describes the wanted replication,
    and contains the following fields:</p>
  <table>
    <thead>
      <tr>
        <th>Field</th>
        <th>Purpose</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><code>_id</code></td>
        <td>Supplying an <code>_id</code> field is optional, but can be useful to identify replication tasks. Cloudant generates a value for you if you do not supply one.</td>
      </tr>
      <tr>
        <td><code>source</code></td>
        <td>The URL of the source Cloudant database, including login credentials.</td>
      </tr>
      <tr>
        <td><code>target</code></td>
        <td>The URL of the destination Cloudant database, including login credentials.</td>
      </tr>
      <tr>
        <td><code>create_target</code></td>
        <td>(Optional) Determine whether to create the destination database if it doesn&#39;t exist yet.</td>
      </tr>
    </tbody>
  </table>
  <p><em>Example of using HTTP to start a replication job:</em></p>
  <pre class="codeblock"><code class="lang-http hljs"><span class="hljs-keyword">POST</span> <span class="hljs-string">/_replicator</span> HTTP/1.1
<span class="hljs-attribute">Content-Type</span>: application/json
<span class="hljs-attribute">Host</span>: myaccount.cloudant.com
<span class="hljs-attribute">Authorization</span>: ...
</code></pre>
  <p><em>Example of using the command line to start a replication job:</em></p>
  <pre class="codeblock"><code class="lang-sh hljs">curl -X POST \
    -H <span class="hljs-string">'Content-type: application/json'</span> \
    <span class="hljs-string">'https://myuser:mypassword@myaccount.cloudant.com/_replicator'</span> \
    <span class="hljs-_">-d</span> <span class="hljs-string">'@replication.json'</span>
</code></pre>
  <p><em>Example JSON document that describes the wanted replication:</em></p>
  <pre class="codeblock"><code class="lang-json hljs">{
    <span class="hljs-attr">"_id"</span>: <span class="hljs-string">"weekly_backup"</span>,
    <span class="hljs-attr">"source"</span>: <span class="hljs-string">"https://username:password@myaccount1.cloudant.com/source"</span>,
    <span class="hljs-attr">"target"</span>: <span class="hljs-string">"https://username:password@myaccount2.cloudant.com/destination"</span>,
    <span class="hljs-attr">"create_target"</span>: <span class="hljs-literal">true</span>
}
</code></pre>
  <h2 id="how-does-replication-affect-the-list-of-changes-">How does replication affect the list of changes?</h2>
  <p>You can get a list of changes made to a document by using the <a href="../api/database.html#get-changes"><code>_changes</code> endpoint</a>. However, the distributed nature of Cloudant databases means that the response that is provided by the <code>_changes</code>    feed cannot be a simple list of changes that occurred after a particular date and time.</p>
  <p>The <a href="cap_theorem.html">CAP Theorem</a> discussion makes it clear that Cloudant uses an &#39;eventually consistent&#39; model. This model means that if you asked two different replicas of a database for a document, at the same time, you might
    get different results if one of the database copies is still waiting to finish replication.
    <em>Eventually</em>, the database copies complete their replication, so that all the changes to a document are present in each copy.</p>
  <p>This &#39;eventual consistency&#39; model has two characteristics that affect a list of changes:</p>
  <ol>
    <li>A change that affects a document almost certainly takes place at different times in different copies of the database.</li>
    <li>The order in which changes affect documents might differ between different copies of the database, depending on when and from where the replication took place.</li>
  </ol>
  <p>A consequence of the first characteristic is that, when you ask for a list of changes, it is meaningless to ask for a list of changes after a specific point in time. The reason is that the list of changes might be supplied by a different database copy,
    which resulted in document updates at different times. However, it <em>is</em> meaningful to ask for a list of changes after a specific change, which is specified by using a sequence identifier.</p>
  <p>An extra consequence of the first characteristic is that it might be necessary to &#39;look back&#39; at preceding changes to agree on the list of changes. In other words, to get a list of changes, you start from the most recent change that the database
    copies agree on. The point of agreement between database copies is identified within Cloudant by using the <a href="#checkpoints">checkpoint</a> mechanism that enables replication between database copies to be synchronized.</p>
  <p>Finally, a consequence of the second characteristic is that the individual changes that appear in the list of changes might be presented in a different order in subsequent requests that are answered by a different database copy. In other words, an initial
    list of changes might report changes <code>A</code>,
    <code>B</code>, then <code>C</code> in that order. But a subsequent list of changes might report changes <code>C</code>,
    <code>A</code>, then <code>B</code> in that order. All the changes are listed, but in a different order. This difference is because the sequence of changes that are received during replication might vary between two different copies of the database.</p>
  <div id="what-this-means-for-the-list-of-changes"></div>
  <h3 id="what-eventual-consistency-means-for-the-list-of-changes">What &#39;eventual consistency&#39; means for the list of changes</h3>
  <p>When you request a list of changes, the response you get might vary depending on which database copy supplies the list.</p>
  <p>If you use the <code>since</code> option to obtain a list of changes after a specific update sequence identifier, you always get the list of changes after that update <em>and</em> you might also get some changes from before that update. The reason is
    that the database copy that responds to the list request must ensure that it lists the changes, consistent with all the replicas. To achieve that consistency, the database copy might have to start the list of changes from the point when all the copies
    agreed. This point is identified by using checkpoints.</p>
  <p>Therefore, an application that uses the <code>_changes</code> feed must be <a href="http://www.eaipatterns.com/IdempotentReceiver.html" target="_blank">&#39;idempotent&#39; <img src="../images/launch-glyph.svg" alt="External link icon" title="External link icon"></a>.
    Idempotency means that the application must be able safely to receive the same data multiple times, and potentially if a different order for repeated requests.</p>
  <h2 id="checkpoints">Checkpoints</h2>
  <p>Internally, the replication process writes its state in &quot;checkpoint&quot; documents that are stored in both the source and destination databases. Checkpoints allow a replication task to be resumed from where it stopped, without having to start
    from the beginning. Checkpoint creation can be prevented by supplying the
    <a href="../api/replication.html#checkpoints"><code>&quot;use_checkpoints&quot;: false</code></a> option when you request replication. It is helpful to leave the feature on if your replication is to resume efficiently from its last known position.</p>
  <h2 id="permissions">Permissions</h2>
  <p>Admin access is necessary to insert a document into the <code>_replicator</code> database. The login credentials that are supplied in the source and target parameters do not require full admin rights. It is sufficient if the credentials are able to:</p>
  <ul>
    <li>Write documents at the destination end.</li>
    <li>Write checkpoint documents at both ends.</li>
  </ul>
  <p>Cloudant has a special <code>_replicator</code> user permission. This permission allows checkpoint documents to be created, but does not allow the creation of ordinary documents in a database. In general,
    <a href="../api/authorization.html#creating-api-keys">create API keys</a> that have:</p>
  <ul>
    <li><code>_reader</code> and <code>_replicator</code> access at the source side.</li>
    <li><code>_reader</code> and <code>_writer</code> access at the destination side.</li>
  </ul>
  <p>API keys can be created and configured within the Cloudant Dashboard, on a per-database basis.</p>
  <p><img src="../images/replication_guide_5.png" alt="replication"></p>
  <p>They can also be created <a href="../api/authorization.html#creating-api-keys">programmatically</a> by using the Cloudant API.</p>
  <h2 id="two-way-replication">Two-way replication</h2>
  <p>Data can be copied in both directions in a process that is known as two-way replication or synchronization. You enable this synchronization by setting up two separate replication processes, one taking the data from A to B, the other taking data from
    B to A. Both replication processes work independently, with data moved seamlessly in both directions.</p>
  <p><img src="../images/replication_guide_6.png" alt="replication6"></p>
  <h2 id="continuous-replication">Continuous replication</h2>
  <p>So far, the discussion deals only with one-shot replication, which finishes when all of the source data is written to the target database. With continuous replication, data flows continuously. All subsequent changes to the source database are transmitted
    to the target database in real time.</p>
  <p>Continuous replication is triggered by clicking the &quot;
    <code>Make this replication continuous</code>&quot; check box when you define a replication task in the Cloudant Dashboard, or by setting the <a href="../api/replication.html#checkpoints">&quot;<code>continuous</code>&quot;</a> flag in the Cloudant
    API.</p>
  <p>Two-way replication can be made continuous in one or both of the directions, by setting the &quot;<code>continuous</code>&quot; flag.</p>
  <p><em>Example of using HTTP to start a continuous replication:</em></p>
  <pre class="codeblock"><code class="lang-http hljs"><span class="hljs-keyword">POST</span> <span class="hljs-string">/_replicator</span> HTTP/1.1
<span class="hljs-attribute">Content-Type</span>: application/json
<span class="hljs-attribute">Host</span>: myaccount.cloudant.com
<span class="hljs-attribute">Authorization</span>: ...
</code></pre>
  <p><em>Example of using the command line to start a continuous replication:</em></p>
  <pre class="codeblock"><code class="lang-sh hljs">curl -X POST \
    -H <span class="hljs-string">"Content-type: application/json"</span> \
    https://myuser:mypassword@myaccount.cloudant.com/_replicator \
    <span class="hljs-_">-d</span> @continuous-replication.json
</code></pre>
  <p><em>Example of a JSON document that defines a continuous replication:</em></p>
  <pre class="codeblock"><code class="lang-json hljs">{
    <span class="hljs-attr">"_id"</span>: <span class="hljs-string">"weekly_continuous_backup"</span>,
    <span class="hljs-attr">"source"</span>: <span class="hljs-string">"https://username:password@myaccount1.cloudant.com/source"</span>,
    <span class="hljs-attr">"target"</span>: <span class="hljs-string">"https://username:password@myaccount2.cloudant.com/destination"</span>,
    <span class="hljs-attr">"continuous"</span>: <span class="hljs-literal">true</span>
}
</code></pre>
  <h2 id="monitoring-replication">Monitoring replication</h2>
  <p>You can check the status of Cloudant’s <code>_replicator</code> database at any time, by using the Dashboard or the API.</p>
  <p>If replication failed, for example if the authentication credentials were invalid, then the error state is recorded in the <code>_replicator</code> document. In addition, the Cloudant account&#39;s <code>/_active_tasks</code> endpoint can be used to
    see replication work as it progresses. More details are available <a href="../api/active_tasks.html">here</a>.</p>
  <p><em>Example of using HTTP to monitor a replication process:</em></p>
  <pre class="codeblock"><code class="lang-http hljs"><span class="hljs-keyword">GET</span> <span class="hljs-string">/_replicator/weekly_backup</span> HTTP/1.1
<span class="hljs-attribute">HOST</span>: myaccount.cloudant.com
<span class="hljs-attribute">Authorization</span>: ...
</code></pre>
  <p><em>Example of using the command line to monitor a replication process:</em></p>
  <pre class="codeblock"><code class="lang-sh hljs">curl <span class="hljs-string">'https://myaccount.cloudant.com/_replicator/weekly_backup'</span>
</code></pre>
  <p><em>Example response to requesting the status of a replication:</em></p>
  <pre class="codeblock"><code class="lang-json hljs">{
    <span class="hljs-attr">"_id"</span>: <span class="hljs-string">"weekly_backup"</span>,
    <span class="hljs-attr">"_rev"</span>: <span class="hljs-string">"22-c57c18f7e761f1a76fa977caa03cd098"</span>,
    <span class="hljs-attr">"source"</span>: <span class="hljs-string">"https://u:p@myaccount.cloudant.com/a"</span>,
    <span class="hljs-attr">"create_target"</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">"target"</span>: <span class="hljs-string">"https://u:p@myaccount.cloudant.com/b"</span>,
    <span class="hljs-attr">"continuous"</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">"_replication_state"</span>: <span class="hljs-string">"triggered"</span>,
    <span class="hljs-attr">"_replication_state_time"</span>: <span class="hljs-string">"2014-12-01T15:19:01+00:00"</span>,
    <span class="hljs-attr">"_replication_id"</span>: <span class="hljs-string">"4514b08cb4c2ded7da9ab04a87182ceb"</span>
}
</code></pre>
  <h2 id="canceling-replication">Canceling replication</h2>
  <p>To stop an ongoing replication job, delete the replication document from the <code>_replicator</code> database, by using either the Dashboard or the API.</p>
  <p><em>Example of using HTTP to cancel a replication:</em></p>
  <pre class="codeblock"><code class="lang-http hljs"><span class="hljs-keyword">DELETE</span> <span class="hljs-string">/_replicator/weekly_backup?rev=22-c57c18f7e761f1a76fa977caa03cd098</span> HTTP/1.1
<span class="hljs-attribute">Host</span>: myaccount.cloudant.com
<span class="hljs-attribute">Authorization:</span>
</code></pre>
  <p><em>Example of using the command line to cancel a replication:</em></p>
  <pre class="codeblock"><code class="lang-sh hljs">curl -X DELETE <span class="hljs-string">'https://myaccount.cloudant.com/_replicator/weekly_backup?rev=22-c57c18f7e761f1a76fa977caa03cd098'</span>
</code></pre>
  <h2 id="other-replication-use-cases">Other replication use-cases</h2>
  <p>Replication isn’t just for Cloudant-to-Cloudant data transfer. Cloudant’s replication protocol is compatible with other databases and libraries for various real-world applications.</p>
  <h3 id="apache-couchdb">Apache CouchDB</h3>
  <p><a href="http://couchdb.apache.org/" target="_blank">Apache CouchDB <img src="../images/launch-glyph.svg" alt="External link icon" title="External link icon"></a> is an open source database that can communicate with Cloudant, and that requires minimal
    setup. Applications include:</p>
  <ul>
    <li>Backup: Replicate your data from Cloudant to your own CouchDB databases and take nightly snapshots of your data for archiving purposes. Send the data to a backup service such as
      <a href="https://aws.amazon.com/glacier/" target="_blank">Amazon Glacier <img src="../images/launch-glyph.svg" alt="External link icon" title="External link icon"></a> for safe keeping.</li>
    <li>Local-first data collection: Write your data to local Apache CouchDB first, then replicate it to Cloudant for long-term storage, aggregation, and analysis.</li>
  </ul>
  <h3 id="pouchdb">PouchDB</h3>
  <p><a href="http://pouchdb.com/" target="_blank">PouchDB <img src="../images/launch-glyph.svg" alt="External link icon" title="External link icon"></a> is an open source, in-browser database that allows data to be replicated in both directions between
    the browser and Cloudant. Storing the data in a web browser on the client side allows web applications to function even without an internet connection. PouchDB can sync any changed data to and from Cloudant when an internet connection is present.
    Setting up replication from the client side requires a few lines of JavaScript.</p>
  <p><em>Example JavaScript that uses PouchDB to enable replication:</em></p>
  <pre class="codeblock"><code class="lang-javascript hljs"><span class="hljs-keyword">var</span> db = <span class="hljs-keyword">new</span> PouchDB(<span class="hljs-string">"myfirstdatabase"</span>);
<span class="hljs-keyword">var</span> URL = <span class="hljs-string">"https://u:p@username.cloudant.com/my_database"</span>);
db.sync(URL, { <span class="hljs-attr">live</span>: <span class="hljs-literal">true</span> });
</code></pre>
  <h3 id="cloudantsync">CloudantSync</h3>
  <p><a href="https://cloudant.com/cloudant-sync-resources/" target="_blank">CloudantSync <img src="../images/launch-glyph.svg" alt="External link icon" title="External link icon"></a> is a set of libraries for iOS and Android that allows data to be stored
    locally in a mobile device and synced with Cloudant when mobile connectivity permits. As with <a href="#pouchdb">PouchDB</a>, setting up replication requires a few lines of code.</p>
  <p><em>Example JavaScript that uses CloudantSync to enable replication:</em></p>
  <pre class="codeblock"><code class="lang-javascript hljs">URI uri = <span class="hljs-keyword">new</span> URI(<span class="hljs-string">"https://u:p@username.cloudant.com/my_database"</span>);
Datastore ds = manager.openDatastore(<span class="hljs-string">"my_datastore"</span>);
<span class="hljs-comment">// Replicate from the local to remote database</span>
Replicator replicator = ReplicatorFactory.oneway(ds, uri);
<span class="hljs-comment">// Fire-and-forget (there are easy ways to monitor the state too)</span>
replicator.start();
</code></pre>
  <p>CloudantSync is used widely in mobile applications, such as iPhone and Android games, where the application&#39;s state is persisted to Cloudant by replication, but the data is also available on the device for offline use.</p>
  <h2 id="filtered-replication">Filtered Replication</h2>
  <p>It is useful to be able to remove some data during the replication process, when you replicate one database to another. Examples include:</p>
  <ul>
    <li>Removing all traces of deleted documents, making the target database smaller than the source.</li>
    <li>Segregating data into smaller chunks, such as storing UK data in one database and US data in another.</li>
  </ul>
  <div id="replication-filter-function"></div>
  <h3 id="replication-filter-functions">Replication filter functions</h3>
  <p>Cloudant’s filtered replication allows the definition of a JavaScript function that uses the return value to determine whether each document in a database is to be filtered or not.
    <a href="../api/design_documents.html#filter-functions">Filter functions</a> are stored in <a href="../api/design_documents.html">design documents</a>.</p>
  <p>The following example is a filter function that allows only non-deleted documents to be replicated.</p>
  <p><em>Example filter function for replicating non-deleted documents:</em></p>
  <pre class="codeblock"><code class="lang-javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">doc, req</span>) </span>{
    <span class="hljs-keyword">if</span> (doc._deleted) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
  <p>When a replication job starts, a filter function’s name is specified as a combination of the design document where it is stored, and the filter function’s name. You can also specify a <code>query_params</code> value. This value is an object that contains
    properties that are passed to the filter function in the <code>query</code> field of its second (<code>req</code>) argument.</p>
  <p><em>Example of using HTTP to start a filtered replication:</em></p>
  <pre class="codeblock"><code class="lang-http hljs"><span class="hljs-keyword">POST</span> <span class="hljs-string">/_replicator</span> HTTP/1.1
<span class="hljs-attribute">Content-Type</span>: application/json
<span class="hljs-attribute">Host</span>: myaccount.cloudant.com
<span class="hljs-attribute">Authorization</span>: ...
</code></pre>
  <p><em>Example of using the command line to start a filtered replication:</em></p>
  <pre class="codeblock"><code class="lang-sh hljs">curl -X POST \
    -H <span class="hljs-string">"Content-type: application/json"</span> \
    https://myuser:mypassword@myaccount.cloudant.com/_replicator \
    <span class="hljs-_">-d</span> @filtered-replication.json
</code></pre>
  <p><em>Example of a JSON document that defines a filtered replication:</em></p>
  <pre class="codeblock"><code class="lang-json hljs">{
    <span class="hljs-attr">"_id"</span>: <span class="hljs-string">"weekly_backup"</span>,
    <span class="hljs-attr">"source"</span>: <span class="hljs-string">"https://username:password@myaccount1.cloudant.com/source"</span>,
    <span class="hljs-attr">"target"</span>: <span class="hljs-string">"https://username:password@myaccount2.cloudant.com/destination"</span>,
    <span class="hljs-attr">"filters"</span>: <span class="hljs-string">"mydesigndoc/myfilter"</span>,
    <span class="hljs-attr">"query_params"</span>: {
        <span class="hljs-attr">"foo"</span>: <span class="hljs-string">"bar"</span>,
        <span class="hljs-attr">"baz"</span>: <span class="hljs-number">5</span>
    }
}
</code></pre>
  <h2 id="changes-feed">Changes feed</h2>
  <p>Cloudant publishes the adds, edits, and deletes affecting a database through a single HTTP feed from the <a href="../api/database.html#get-changes"><code>_changes</code> endpoint</a>. This feed can be used by your application to trigger events. You
    can access the feed by using HTTP or <code>curl</code>, as shown in the examples. Using the <code>feed=continuous</code> option means that the stream provides you with every change that is necessary to get the most recent version of every document
    in the database.</p>
  <p><em>Example of using HTTP to query the changes feed:</em></p>
  <pre class="codeblock"><code class="lang-http hljs"><span class="hljs-keyword">GET</span> <span class="hljs-string">/$db/_changes?feed=continuous</span> HTTP/1.1
<span class="hljs-attribute">Host</span>: myaccount.cloudant.com
<span class="hljs-attribute">Authorization</span>: ...
</code></pre>
  <p><em>Example of using the command line to query the changes feed:</em></p>
  <pre class="codeblock"><code class="lang-sh hljs">curl <span class="hljs-string">"https://myaccount.cloudant.com/<span class="hljs-variable">$db</span>/_changes?feed=continuous"</span>
</code></pre>
  <p>The changes are described by using one line per change. Each change consists of:</p>
  <ol>
    <li>A string that contains a sequence number (<code>seq</code>).</li>
    <li>A string that contains the ID of the document that was changed.</li>
    <li>An array of changes.</li>
  </ol>
  <p>To see the document body itself, append <code>&amp;include_docs=true</code> to the curl command.</p>
  <p>Each change is described by using the format that is shown in the following (abbreviated) example.</p>
  <p><em>Example <code>_changes</code> feed:</em></p>
  <pre class="codeblock"><code class="lang-json hljs">{
    <span class="hljs-attr">"seq"</span>:<span class="hljs-string">"11-g1A...c1Q"</span>,
    <span class="hljs-attr">"id"</span>:<span class="hljs-string">"6f8ab9fa52c117eb76240daa1a55827f"</span>,
    <span class="hljs-attr">"changes"</span>:[
        {
          <span class="hljs-attr">"rev"</span>:<span class="hljs-string">"1-619d7981d7027274a4b88810d318a7b1"</span>
        }
    ]
}
</code></pre>
  <div id="changes-feed-since"></div>
  <p>To join the changes feed from a known position, pass a <a href="../api/database.html#the-since-argument"><code>since</code> argument</a> with the sequence number you want to start from.</p>
  <p><em>Example (abbreviated) of using HTTP to supply the <code>since</code> option to join a <code>_changes</code> feed at a known position:</em></p>
  <pre class="codeblock"><code class="lang-http hljs"><span class="hljs-keyword">GET</span> <span class="hljs-string">/$db/_changes?feed=continuous&amp;include_docs=true&amp;since=11-g1A...c1Q</span> HTTP/1.1
<span class="hljs-attribute">HOST</span>: myaccount.cloudant.com
<span class="hljs-attribute">Authorization</span>: ...
</code></pre>
  <p><em>Example (abbreviated) of using the command line to supply the <code>since</code> option to join a <code>_changes</code> feed at a known position,:</em></p>
  <pre class="codeblock"><code class="lang-sh hljs">curl <span class="hljs-string">"https://myaccount.cloudant.com/<span class="hljs-variable">$db</span>/_changes?feed=continuous&amp;include_docs=true&amp;since=11-g1A...c1Q"</span>
</code></pre>
  <div id="changes-feed-since-now"></div>
  <p>To rejoin the changes feed from the current moment in time, set <code>since=now</code>.</p>
  <p><em>Example of using HTTP to supply <code>since=now</code> to join a <code>_changes</code> feed at the current moment in time:</em></p>
  <pre class="codeblock"><code class="lang-http hljs"><span class="hljs-keyword">GET</span> <span class="hljs-string">/$db/_changes?feed=continuous&amp;include_docs=true&amp;since=now</span> HTTP/1.1
<span class="hljs-attribute">Host</span>: myaccount.cloudant.com
<span class="hljs-attribute">Authorization</span>: ...
</code></pre>
  <p><em>Example of using the command line to supply <code>since=now</code> to join a <code>_changes</code> feed at the current moment in time:</em></p>
  <pre class="codeblock"><code class="lang-sh hljs">curl <span class="hljs-string">"https://myaccount.cloudant.com/<span class="hljs-variable">$db</span>/_changes?feed=continuous&amp;include_docs=true&amp;since=now"</span>
</code></pre>
  <p><em>Example of using JavaScript to supply <code>since=now</code> to join a <code>_changes</code> feed at the current moment in time:</em></p>
  <pre class="codeblock"><code class="lang-javascript hljs"><span class="hljs-keyword">var</span> feed = db.follow({<span class="hljs-attr">since</span>: <span class="hljs-string">"now"</span>, <span class="hljs-attr">include_docs</span>: <span class="hljs-literal">true</span>})
feed.on(<span class="hljs-string">'change'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">change</span>) </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"change: "</span>, change);
})
feed.follow();
</code></pre>
  <p>Accessing the <code>_changes</code> data programmatically is straightforward. For example, use the <a href="../libraries/supported.html#node-js">Cloudant Node.js library</a> to follow changes with a few lines of code.</p>
  <p>Example use cases might be:</p>
  <ul>
    <li>Adding items to a message queue to trigger actions within your application, such as sending a customer email.</li>
    <li>Update an in-memory database to record live counts of activity.</li>
    <li>Writing data to a text file to push data into an SQL database.</li>
  </ul>
  <div id="changes-feed-filtering"></div>
  <p>The changes feed can be filtered with a filter function, by using a similar technique to <a href="#filtered-replication">filtering during replication</a>.</p>
  <p><em>Example of using HTTP to filter the changes feed:</em></p>
  <pre class="codeblock"><code class="lang-http hljs"><span class="hljs-keyword">GET</span> <span class="hljs-string">/$db/_changes?feed=continuous&amp;include_docs=true&amp;since=now&amp;filter=mydesigndoc/myfilter</span> HTTP/1.1
<span class="hljs-attribute">Host</span>: myaccount.cloudant.com
<span class="hljs-attribute">Authorization</span>: ...
</code></pre>
  <p><em>Example of using the command line to filter the changes feed:</em></p>
  <pre class="codeblock"><code class="lang-sh hljs">curl <span class="hljs-string">"https://myaccount.cloudant.com/<span class="hljs-variable">$db</span>/_changes?feed=continuous&amp;include_docs=true&amp;since=now&amp;filters=mydesigndoc/myfilter"</span>
</code></pre>
  <blockquote>
    <p> <strong>Note</strong>: The ordering of documents within the <code>_changes</code> feed is not always the same. In other words, changes might not appear in strict time order. The reason is that data is returned from multiple Cloudant nodes, and eventual
      consistency rules apply.</p>
  </blockquote>
  <h2 id="replication-pitfalls">Replication Pitfalls</h2>
  <p>Several considerations apply when you use replication.</p>
  <h3 id="incorrect-user-permissions">Incorrect user permissions</h3>
  <p>For replication to proceed optimally when you replicate from database &quot;a&quot; to database &quot;b&quot;, the credentials that are supplied must have:</p>
  <ul>
    <li><code>_reader</code> and <code>_replicator</code> rights on database &quot;a&quot;.</li>
    <li><code>_writer</code> rights on database &quot;b&quot;.</li>
  </ul>
  <p>API keys are generated in the Cloudant Dashboard or <a href="../api/authorization.html#creating-api-keys">through the API</a>. Each key can be given individual rights that relate to a specific Cloudant database. Cloudant must be able to write its checkpoint
    documents at the &quot;read&quot; end of replication, otherwise no state is saved and replication cannot resume from where it stopped. If the state is not saved, it can lead to performance problems when replication of large data sets resumes. The
    reason is that without checkpoints, the replication process restarts from the beginning each time that it is resumed.</p>
  <h3 id="replication-document-is-conflicted">Replication document is conflicted</h3>
  <p>Another consequence of setting user permissions incorrectly is that the <code>_replicator</code> document becomes conflicted. The <code>_replicator</code> document records the current state of the replication process. In an extreme case, the document
    can become huge because it contains many unresolved conflicts. Such a large document uses much of the available space and causes extra server load.</p>
  <p>You can check the size of your <code>_replicator</code> database by sending a <code>GET</code> request to the <code>/_replicator</code> endpoint:</p>
  <pre class="codeblock"><code class="lang-http hljs">GET https://myaccount.cloudant.com/_replicator
</code></pre>
  <p>In the returned JSON, look for the <code>disk_size</code> value. If the value indicates a size of over 1 GB, contact the <a href="mailto:support@cloudant.com" target="_blank">IBM Cloudant support team <img src="../images/launch-glyph.svg" alt="External link icon" title="External link icon"></a>    for further advice.</p>
  <p>You can check an individual <code>_replicator</code> document for conflicts, as shown in the following example:</p>
  <pre class="codeblock"><code class="lang-http hljs">GET https://myaccount.cloudant.com/_replicator/&lt;&lt;docid&gt;&gt;?conflicts=true
</code></pre>
  <div id="resetting-replicator-database"></div>
  <p>If you want to cancel all replications and start with a new, clean <code>_replicator</code> database, delete then re-create the <code>replicator</code> database.</p>
  <p><em>Example of using HTTP to remove and re-create the <code>_replicator</code> database:</em></p>
  <pre class="codeblock"><code class="lang-http hljs"><span class="hljs-keyword">DELETE</span> <span class="hljs-string">/_replicator</span> HTTP/1.1
<span class="hljs-attribute">HOST</span>: myaccount.cloudant.com
<span class="hljs-attribute">Authorization</span>: ...

<span class="http"><span class="hljs-keyword">PUT</span> <span class="hljs-string">/_replicator</span> HTTP/1.1
<span class="hljs-attribute">HOST</span>: myaccount.cloudant.com
<span class="hljs-attribute">Authorization</span>: ...</span>
</code></pre>
  <p><em>Example of using the command line to remove and re-create the <code>_replicator</code> database:</em></p>
  <pre class="codeblock"><code class="lang-sh hljs">curl -X DELETE <span class="hljs-string">'https://myaccount.cloudant.com/_replicator'</span>
curl -X PUT <span class="hljs-string">'https://myaccount.cloudant.com/_replicator'</span>
</code></pre>
  <h3 id="many-simultaneous-replications">Many simultaneous replications</h3>
  <p>It is easy to forget that you previously set-up replication between two databases, and so create extra replication processes in error. Each replication job is independent of the other, so Cloudant does not prevent you from doing creating extra replication
    processes. However, each replication task uses up system resources.</p>
  <p>You can check your &quot;active replications&quot; in the Cloudant Dashboard to ensure that there are no unwanted replication tasks in progress. Delete any <code>_replicator</code> documents that are no longer needed.</p>
  <h2 id="tuning-replication-speed">Tuning replication speed</h2>
  <p>By default, Cloudant replication runs at an appropriate rate to get the data from the source to the target without adversely affecting performance. Choosing between replication rate and cluster performance for other tasks is a tradeoff. Your use-case
    might require faster replication at the expense of other Cloudant services. Alternatively, you might require cluster performance to take priority, with replication treated as a background process.</p>
  <p>Advanced replication API options are <a href="../api/advanced_replication.html">available</a>, which enable an increase or decrease in the amount of computing power that is used during replication. For example:</p>
  <ul>
    <li>If your documents contain attachments, you might want to consider reducing the batch_size and increasing the worker_processes, to accommodate larger documents in smaller batches.</li>
    <li>If you have many tiny documents, then you might consider increasing the
      <a href="../api/advanced_replication.html#performance-related-options"><code>worker_process</code></a> and
      <a href="../api/advanced_replication.html#performance-related-options"><code>http_connections</code></a> values.</li>
    <li>If you want to run replication with minimal impact, setting <code>worker_processes</code> and <code>http_connections</code> to 1 might be appropriate.</li>
  </ul>
  <p>For further assistance about the best configuration for your use-case, contact the <a href="mailto:support@cloudant.com" target="_blank">IBM Cloudant support team <img src="../images/launch-glyph.svg" alt="External link icon" title="External link icon"></a>.</p>
  <footer>
    <div>
      <p>Copyright &copy; 2015, 2017. All Rights Reserved.</p>
    </div>
  </footer>
</body>
</html>